M.define("/js/Dropdown",function(c,b,d){function a(e){this.$nav=typeof e.nav==="string"?$(e.nav):e.nav;this.$panel=typeof e.panel==="string"?$(e.panel):e.panel;this.showCallback=e.showCallback;this.hideCallback=e.hideCallback;this.delay=e.delay||0;this.event=e.event||"mouseenterleave";this._isShow=false;this.init()}a.prototype={init:function(){if(this.event==="mouseenterleave"){this.$nav.on("mouseenter.dropdown",M.bind(function(e){this.show()},this)).on("mouseleave.dropdown",M.bind(function(e){if($(e.relatedTarget).closest(this.$panel).length===0){this.hide(true)}},this));this.$panel.on("mouseenter.dropdown",M.bind(function(e){this.show()},this)).on("mouseleave.dropdown",M.bind(function(e){if($(e.relatedTarget).closest(this.$nav).length===0){this.hide(false)}},this))}if(this.event==="click"){this.$nav.on("click.dropdown",M.bind(function(e){this.show()},this));$(document).on("click.dropdown",M.bind(function(e){if($(e.target).closest(this.$nav).length===0&&$(e.target).closest(this.$panel).length===0){this.hide(false)}},this))}},show:function(){this.$panel.show();this._isShow=true;if(M.isFunction(this.showCallback)){this.showCallback.call(this,this.$nav,this.$panel)}},hide:function(e){this._isShow=false;if(e&&this.delay>0){setTimeout(M.bind(function(){if(!this._isShow){this.$panel.hide();if(M.isFunction(this.hideCallback)){this.hideCallback.call(this,this.$nav,this.$panel)}}},this),this.delay)}else{this.$panel.hide();if(M.isFunction(this.hideCallback)){this.hideCallback.call(this,this.$nav,this.$panel)}}},destory:function(){if(this.event==="mouseenterleave"){this.$nav.off("mouseenter.dropdown").off("mouseleave.dropdown");this.$panel.off("mouseenter.dropdown").off("mouseleave.dropdown")}if(this.event==="click"){this.$nav.off("click.dropdown")}this.$panel.hide()}};d.exports=a});M.define("/js/pageletcommon/pageHeadUserInfoWWWNormal",function(c){var a=c("/js/Dropdown"),b=window.Env||{};return{events:{},init:function(){var k=$("#head-btn-daka");$(function(){$(".new_daka_tips").addClass("on")});$(".ndt_close").on("click",function(){$(this).parent().hide()});M.Event.on("afterDaka",l);function l(q){if(q&&q.dakaFlag){k.closest(".head-daka").addClass("daka-complete")}}var e=i("dakaday");if(e!==null){$(".head-btn-daka").attr("data-day",e)}function i(q){var s=new RegExp("(^|&)"+q+"=([^&]*)(&|$)");var t=window.location.search.substr(1).match(s);if(t!==null){return unescape(t[2])}return null}var g=new a({nav:"#_j_head_user",panel:"#_j_user_panel",showCallback:function(q,r){q.find(".drop-trigger").addClass("drop-trigger-active")},hideCallback:function(q,r){q.find(".drop-trigger").removeClass("drop-trigger-active")},delay:500});var d=0,p=$("#_j_head_msg"),o=$("#_j_msg_panel"),n=p.find(".head-msg-new"),j=$("#_j_msg_float_panel");var f=new a({nav:p.selector,panel:o.selector,showCallback:function(q,r){q.find(".drop-trigger").addClass("drop-trigger-active")},hideCallback:function(q,r){q.find(".drop-trigger").removeClass("drop-trigger-active")},delay:200});M.Event.on("get new msg",function(q){if(q.msg||d>0){o.find("ul").html(q.menu_index);h()}});o.on("click","a",function(q){M.Event.fire("update msg")});j.on("click","ul a",function(q){M.Event.fire("update msg")});j.on("click",".close-newmsg",function(q){m()});function m(){n.hide();j.hide();$.ajax({url:"http://"+b.WWW_HOST+"/ajax/ajax_msg.php",dataType:"jsonp",data:{a:"ignore",from:"1"},success:function(q){M.Event.fire("update msg")}})}window.close_msg_tips=m;function h(){var q="";d=0;o.find(".num").each(function(r,t){var s=$(t);d+=Number(s.html());q+="<li>"+s.closest("li").html()+"</li>"});if(d>0){n.html((d>99?"99+":d)).show();j.find("ul").html(q).end().show()}else{n.hide();j.hide()}}h()}}});
/*!
 * jQuery Templates Plugin 1.0.0pre
 * http://github.com/jquery/jquery-tmpl
 * Requires jQuery 1.4.2
 *
 * Copyright 2011, Software Freedom Conservancy, Inc.
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 */
(function(i,f){var t=i.fn.domManip,h="_tmplitem",u=/^[^<]*(<[\w\W]+>)[^>]*$|\{\{\! /,p={},e={},y,x={key:0,data:{}},w=0,q=0,g=[];function k(B,A,D,E){var C={data:E||(E===0||E===false)?E:(A?A.data:{}),_wrap:A?A._wrap:null,tmpl:null,parent:A||null,nodes:[],calls:c,nest:b,wrap:n,html:r,update:z};if(B){i.extend(C,B,{nodes:[],parent:A})}if(D){C.tmpl=D;C._ctnt=C._ctnt||C.tmpl(i,C);C.key=++w;(g.length?e:p)[w]=C}return C}i.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(A,B){i.fn[A]=function(C){var F=[],I=i(C),E,G,D,J,H=this.length===1&&this[0].parentNode;y=p||{};if(H&&H.nodeType===11&&H.childNodes.length===1&&I.length===1){I[B](this[0]);F=this}else{for(G=0,D=I.length;G<D;G++){q=G;E=(G>0?this.clone(true):this).get();i(I[G])[B](E);F=F.concat(E)}q=0;F=this.pushStack(F,A,I.selector)}J=y;y=null;i.tmpl.complete(J);return F}});i.fn.extend({tmpl:function(C,B,A){return i.tmpl(this[0],C,B,A)},tmplItem:function(){return i.tmplItem(this[0])},template:function(A){return i.template(A,this[0])},domManip:function(E,H,G,I){if(E[0]&&i.isArray(E[0])){var B=i.makeArray(arguments),A=E[0],F=A.length,C=0,D;while(C<F&&!(D=i.data(A[C++],"tmplItem"))){}if(D&&q){B[2]=function(J){i.tmpl.afterManip(this,J,G)}}t.apply(this,B)}else{t.apply(this,arguments)}q=0;if(!y){i.tmpl.complete(p)}return this}});i.extend({tmpl:function(C,F,E,B){var D,A=!B;if(A){B=x;C=i.template[C]||i.template(null,C);e={}}else{if(!C){C=B.tmpl;p[B.key]=B;B.nodes=[];if(B.wrapped){s(B,B.wrapped)}return i(m(B,null,B.tmpl(i,B)))}}if(!C){return[]}if(typeof F==="function"){F=F.call(B||{})}if(E&&E.wrapped){s(E,E.wrapped)}D=i.isArray(F)?i.map(F,function(G){return G?k(E,B,C,G):null}):[k(E,B,C,F)];return A?i(m(B,null,D)):D},tmplItem:function(B){var A;if(B instanceof i){B=B[0]}while(B&&B.nodeType===1&&!(A=i.data(B,"tmplItem"))&&(B=B.parentNode)){}return A||x},template:function(B,A){if(A){if(typeof A==="string"){A=l(A)}else{if(A instanceof i){A=A[0]||{}}}if(A.nodeType){A=i.data(A,"tmpl")||i.data(A,"tmpl",l(A.innerHTML))}return typeof B==="string"?(i.template[B]=A):A}return B?(typeof B!=="string"?i.template(null,B):(i.template[B]||i.template(null,u.test(B)?B:i(B)))):null},encode:function(A){return(""+A).split("<").join("&lt;").split(">").join("&gt;").split('"').join("&#34;").split("'").join("&#39;")}});i.extend(i.tmpl,{tag:{tmpl:{_default:{$2:"null"},open:"if($notnull_1){__=__.concat($item.nest($1,$2));}"},wrap:{_default:{$2:"null"},open:"$item.calls(__,$1,$2);__=[];",close:"call=$item.calls();__=call._.concat($item.wrap(call,__));"},each:{_default:{$2:"$index, $value"},open:"if($notnull_1){$.each($1a,function($2){with(this){",close:"}});}"},"if":{open:"if(($notnull_1) && $1a){",close:"}"},"else":{_default:{$1:"true"},open:"}else if(($notnull_1) && $1a){"},html:{open:"if($notnull_1){__.push($1a);}"},"=":{_default:{$1:"$data"},open:"if($notnull_1){__.push($.encode($1a));}"},"!":{open:""}},complete:function(A){p={}},afterManip:function v(C,A,D){var B=A.nodeType===11?i.makeArray(A.childNodes):A.nodeType===1?[A]:[];D.call(C,A);o(B);q++}});function m(A,E,C){var D,B=C?i.map(C,function(F){return(typeof F==="string")?(A.key?F.replace(/(<\w+)(?=[\s>])(?![^>]*_tmplitem)([^>]*)/g,"$1 "+h+'="'+A.key+'" $2'):F):m(F,A,F._ctnt)}):A;if(E){return B}B=B.join("");B.replace(/^\s*([^<\s][^<]*)?(<[\w\W]+>)([^>]*[^>\s])?\s*$/,function(G,H,F,I){D=i(F).get();o(D);if(H){D=a(H).concat(D)}if(I){D=D.concat(a(I))}});return D?D:a(B)}function a(B){var A=document.createElement("div");A.innerHTML=B;return i.makeArray(A.childNodes)}function l(A){return new Function("jQuery","$item","var $=jQuery,call,__=[],$data=$item.data;with($data){__.push('"+i.trim(A).replace(/([\\'])/g,"\\$1").replace(/[\r\t\n]/g," ").replace(/\$\{([^\}]*)\}/g,"{{= $1}}").replace(/\{\{(\/?)(\w+|.)(?:\(((?:[^\}]|\}(?!\}))*?)?\))?(?:\s+(.*?)?)?(\(((?:[^\}]|\}(?!\}))*?)\))?\s*\}\}/g,function(I,C,G,D,E,J,F){var L=i.tmpl.tag[G],B,H,K;if(!L){throw"Unknown template tag: "+G}B=L._default||[];if(J&&!/\w$/.test(E)){E+=J;J=""}if(E){E=j(E);F=F?(","+j(F)+")"):(J?")":"");H=J?(E.indexOf(".")>-1?E+j(J):("("+E+").call($item"+F)):E;K=J?H:"(typeof("+E+")==='function'?("+E+").call($item):("+E+"))"}else{K=H=B.$1||"null"}D=j(D);return"');"+L[C?"close":"open"].split("$notnull_1").join(E?"typeof("+E+")!=='undefined' && ("+E+")!=null":"true").split("$1a").join(K).split("$1").join(H).split("$2").join(D||B.$2||"")+"__.push('"})+"');}return __;")}function s(B,A){B._wrap=m(B,true,i.isArray(A)?A:[u.test(A)?A:i(A).html()]).join("")}function j(A){return A?A.replace(/\\'/g,"'").replace(/\\\\/g,"\\"):null}function d(A){var B=document.createElement("div");B.appendChild(A.cloneNode(true));return B.innerHTML}function o(G){var I="_"+q,B,A,E={},F,D,C;for(F=0,D=G.length;F<D;F++){if((B=G[F]).nodeType!==1){continue}A=B.getElementsByTagName("*");for(C=A.length-1;C>=0;C--){H(A[C])}H(B)}function H(P){var L,O=P,N,J,K;if((K=P.getAttribute(h))){while(O.parentNode&&(O=O.parentNode).nodeType===1&&!(L=O.getAttribute(h))){}if(L!==K){O=O.parentNode?(O.nodeType===11?0:(O.getAttribute(h)||0)):0;if(!(J=p[K])){J=e[K];J=k(J,p[O]||e[O]);J.key=++w;p[w]=J}if(q){Q(K)}}P.removeAttribute(h)}else{if(q&&(J=i.data(P,"tmplItem"))){Q(J.key);p[J.key]=J;O=i.data(P.parentNode,"tmplItem");O=O?O.key:0}}if(J){N=J;while(N&&N.key!=O){N.nodes.push(P);N=N.parent}delete J._ctnt;delete J._wrap;i.data(P,"tmplItem",J)}function Q(R){R=R+I;J=E[R]=(E[R]||k(J,p[J.parent.key+I]||J.parent))}}}function c(C,A,D,B){if(!C){return g.pop()}g.push({_:C,tmpl:A,item:this,data:D,options:B})}function b(A,C,B){return i.tmpl(i.template(A),C,B,this)}function n(C,A){var B=C.options||{};B.wrapped=A;return i.tmpl(i.template(C.tmpl),C.data,B,C.item)}function r(B,C){var A=this._wrap;return i.map(i(i.isArray(A)?A.join(""):A).filter(B||"*"),function(D){return C?D.innerText||D.textContent:D.outerHTML||d(D)})}function z(){var A=this.nodes;i.tmpl(null,null,null,this).insertBefore(A[0]);i(A).remove()}if(window.M&&typeof M.define=="function"){M.define("jq-tmpl",function(){return i})}})(jQuery);M.define("InputListener",function(c,b,d){var a={listen:function(f,e){f=$(f);f.each($.proxy(function(g,h){h=$(h);if(!h.is("input")&&!h.is("textarea")){throw new Error("input listener only apply to input or textarea")}this.initListen(h,e)},this))},unlisten:function(e){e=$(e);e.each($.proxy(function(h,k){k=$(k);if(!k.is("input")&&!k.is("textarea")){throw new Error("input listener only apply to input or textarea")}if(arguments.length==1){k.unbind("focus",this.getStartListenFunc());k.unbind("blur",this.getStopListenFunc());k.removeData("__input_listener_handlers")}else{if(typeof arguments[1]=="function"){var j=arguments[1],g=k.data("__input_listener_listeninterval");for(var h=0,f=g.length;h<f;h++){if(g[h]==j){g.splice(h,1);h--}}}}},this))},initListen:function(f,e){f.data("__input_listener_currentval",f.val());if(!f.data("__input_listener_handlers")){this.bindListenEvent(f)}this.addListenHandler(f,e);if(f.is(":focus")){f.blur();f.focus()}},bindListenEvent:function(e){e.data("__input_listener_handlers",[]);e.focus(this.getStartListenFunc());e.blur(this.getStopListenFunc())},getStartListenFunc:function(){if(!this.bindStartListenFunc){this.bindStartListenFunc=$.proxy(this.startListen,this)}return this.bindStartListenFunc},getStopListenFunc:function(){if(!this.bindStopListenFunc){this.bindStopListenFunc=$.proxy(this.stopListen,this)}return this.bindStopListenFunc},startListen:function(e){var f=$(e.target);f.data("__input_listener_currentval",f.val());f.data("__input_listener_listeninterval",setInterval($.proxy(function(){var h=f.data("__input_listener_currentval"),g=f.val();if(h!=g){f.data("__input_listener_currentval",g);this.triggerListenHandler(f)}},this),100))},stopListen:function(e){var f=$(e.target);clearInterval(f.data("__input_listener_listeninterval"))},addListenHandler:function(f,e){if(typeof e=="function"){f.data("__input_listener_handlers").push(e)}},triggerListenHandler:function(h){var f=h.data("__input_listener_handlers");for(var g=0,e=f.length;g<e;g++){f[g].call(null,{target:h.get(0)})}}};return a});M.define("SuggestionXHR",function(b,a,c){function d(e){this.URL=null;this.delay=200;this.dataType="text";$.extend(this,e);this.delayTimer=null;this.xhr=null;this.cache={};this.init()}d.prototype={init:function(){if(!this.URL){throw new Error("no url for suggestion")}},getSuggestion:function(g,h){var f=this.getQuery(g),e=this.cache[f];h=typeof h==="function"?h:$.noop;this.stop();if(e){h(e)}else{this.getXHRData(f,h)}},stop:function(){clearTimeout(this.delayTimer);if(this.xhr&&this.xhr.readyState!==4){this.xhr.abort()}},getQuery:function(h){var g="";if(typeof h=="string"){g=encodeURIComponent(h)}else{if(h&&typeof h=="object"){var e=[];for(var f in h){if(h.hasOwnProperty(f)){e.push(f+"="+encodeURIComponent(h[f]))}}g=e.join("&")}}return g},getXHRData:function(e,h){var f=this.xhr,g={url:this.URL,data:e,dataType:this.dataType,success:M.bind(function(i){h(i);this.cache[e]=i},this)};this.delayTimer=setTimeout(M.bind(function(){this.xhr=$.ajax(g)},this),this.delay)}};return d});M.define("DropList",function(c,b,d){var a=M.Event;function e(f){this.trigger=null;this.container=null;this.itemSelector="._j_listitem";this.itemHoverClass="on";this.firstItemHover=false;$.extend(this,f);this.trigger=$(this.trigger);this.container=$(this.container);this.mouseon=false;this.visible=false;this.init()}M.mix(e.prototype,{createContainer:$.noop,updateList:$.noop,init:function(){if(!this.trigger.length){M.error("no trigger for drop list")}if(!this.container.length){this.container=this.createContainer()}if(!this.container.length){M.error("no container for drop list")}this.bindEvents()},bindEvents:function(){this.trigger.on("keydown",$.proxy(function(g){var h=g.keyCode;if(this.visible&&h==13){var f=this.getFocusItem();if(f.length){this.selectItem(f);g.preventDefault()}}else{if(this.visible&&h==38){this.moveFocus(-1)}else{if(this.visible&&h==40){this.moveFocus(1)}}}},this));this.container.on("mouseenter",this.itemSelector,$.proxy(this.moveFocus,this)).on("click",this.itemSelector,$.proxy(this.clickItem,this)).on("mouseenter",$.proxy(this.mouseOverCnt,this)).on("mouseleave",$.proxy(this.mouseOutCnt,this))},show:function(g){this.updateList(g);this.container.show();if(this.firstItemHover){var f=this.container.find(this.itemSelector);if(f.length){this.moveFocus(1)}}this.visible=true},hide:function(){this.container.hide();this.visible=false},clickItem:function(g){var f=this.getFocusItem();this.selectItem(f);g.preventDefault()},selectItem:function(f){a(this).fire("itemselected",{item:f})},moveFocus:function(i){var h=this.container.find(this.itemSelector),j=this.getFocusItem(),g=j,f;if(i===-1){if(j.length){f=h.index(j)-1}if(!j.length||f==-1){g=h.last()}else{g=h.eq(f)}}else{if(i===1){if(j.length){f=h.index(j)+1}if(!j.length||f==h.length){g=h.first()}else{g=h.eq(f)}}else{if(i.currentTarget){g=$(i.currentTarget)}}}j.removeClass(this.itemHoverClass);g.addClass(this.itemHoverClass);a(this).fire("itemfocused",{prevItem:j,focusItem:g})},getFocusItem:function(){var f=this.container.find(this.itemSelector);return f.filter("."+this.itemHoverClass)},mouseOverCnt:function(){this.mouseon=true},mouseOutCnt:function(){this.mouseon=false}});return e});M.define("Suggestion",function(c){c("jq-tmpl");var a=c("InputListener");var b='{{each(i, item) list}}<li class="${listItemClass}" data-value="${item.value}">${item.text}</li>{{/each}}';function d(e){e.suggestionURL=e.url||$(e.input).data("suggestionurl");this.dropListClass="droplist";this.listItemSelector="._j_listitem";this.listItemHoverClass="on";this.listFirstItemHover=false;this.keyParamName="key";this.dataType="json";this.suggestionParams={};this.listContainer=null;M.mix(this,e);this.input=$(this.input);this.listTmpl=this.listTmpl||b;this.actOnList=false;this.init()}M.mix(d.prototype,{init:function(){a.listen(this.input,$.proxy(this.inputChange,this));this.input.blur($.proxy(function(f){var e=$(f.currentTarget);if(e.data("droplist")){setTimeout($.proxy(function(){if(!this.actOnList&&e.data("droplist")){e.data("droplist").hide()}this.actOnList=false},this),200)}},this));this.input.keyup($.proxy(function(f){var e=$(f.currentTarget);if(f.keyCode==40&&(!e.data("droplist")||!e.data("droplist").visible)){this.inputChange(f)}},this))},inputChange:function(i){var f=$(i.target),k=$.trim(f.val()),j=c("SuggestionXHR"),h=c("DropList");var g=f.data("droplist");if(!g){f.data("droplist",g=new h({trigger:f,itemSelector:this.listItemSelector,itemHoverClass:this.listItemHoverClass,firstItemHover:this.listFirstItemHover,container:this.listContainer,createContainer:$.proxy(function(){var l=this.createListContainer(f);this.listContainer=l;return l},this),updateList:$.proxy(this.updateList,this)}));M.Event(g).on("itemselected",$.proxy(function(l){this.dropItemSelected(f,l.item)},this));M.Event(g).on("itemfocused",$.proxy(function(l){M.Event(this).fire("itemfocused",l)},this))}g.hide=function(){setTimeout($.proxy(function(){if(M.windowFocused){this.container.hide();this.visible=false}},this),1)};var e=f.data("suggestion");if(!e){f.data("suggestion",e=new j({URL:this.suggestionURL,dataType:this.dataType}))}if(!k.length){e.stop();g.hide();M.Event(this).fire("after hide list")}else{this.suggestionParams[this.keyParamName]=k;M.Event(this).fire("before suggestion xhr");e.getSuggestion(this.suggestionParams,$.proxy(function(m){M.Event(this).fire("before show list");var l=this.handleSuggest(m);if(l){f.data("droplist").show(l)}},this))}},handleSuggest:function(f){var e="";if(this.dataType=="json"){e=$.tmpl(this.listTmpl,f)}return e},createListContainer:function(f){var g=$("<ul />"),e=f.position();g.css({display:"none",position:"absolute",left:e.left,top:e.top+f.outerHeight()}).addClass(this.dropListClass);g.insertAfter(f);return g},updateList:function(e){this.listContainer.html(e)},hideDropList:function(){this.input.data("droplist")&&this.input.data("droplist").hide()},dropItemSelected:function(e,f){a.unlisten(e);M.Event(this).fire("itemselected",{item:f,input:e});a.listen(e,$.proxy(this.inputChange,this))}});return d});M.define("MesSearchEvent",function(b,a,c){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(f,j){var l=e,h=[],g;j=j||l.length;if(f){for(g=0;g<f;g++){h[g]=l[0|Math.random()*j]}}else{var k;h[8]=h[13]=h[18]=h[23]="-";h[14]="4";for(g=0;g<36;g++){if(!h[g]){k=0|Math.random()*16;h[g]=l[(g==19)?(k&3)|8:k]}}}return h.join("")};Math.uuidFast=function(){var k=e,h=new Array(36),g=0,j;for(var f=0;f<36;f++){if(f==8||f==13||f==18||f==23){h[f]="-"}else{if(f==14){h[f]="4"}else{if(g<=2){g=33554432+(Math.random()*16777216)|0}j=g&15;g=g>>4;h[f]=k[(f==19)?(j&3)|8:j]}}}return h.join("")};Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(h){var g=Math.random()*16|0,f=h=="x"?g:(g&3|8);return f.toString(16)})};var d={uuid:function(){return Math.uuid()},search:function(f){var g=Math.uuid();f.id=g;!!mfwPageEvent&&mfwPageEvent("se","v2_search",f);return g},searchCache:function(f){var g=Math.uuid();f.id=g;!!mfwPageEvent&&mfwPageEvent("se","v2_search_cache",f);return g},resultClick:function(f){!!mfwPageEvent&&mfwPageEvent("se","v2_result_click",f);return f.id}};c.exports=d});M.define("/js/SiteSearch",function(e){var d="1.0.0",h=e("Suggestion"),f=e("MesSearchEvent"),g=M.cssSupport("transition"),b=M.cssSupport("transform"),c=window.Env||{};var a=function(C){var E=$("#"+C.input+""),T=!!C.submit?$("#"+C.submit+""):null,t=C.additionalClass?C.additionalClass:"",K=!!C.isRelevant,s=C.maxCount||0,z=C.hideOnScroll||false,n=false,J=false,i="",y="",l="",p="";if(C.input==="_j_index_search_input_all"){var H=[];if(E.val()===""&&H&&H.length){var S=Math.floor(Math.random()*H.length),I=H[S];E.val(I.name).data("url",I.url)}E.on("focus",function(V){if(E.data("url")){E.val("").data("url","")}})}if(c.is_async_site_search){n=true}var P=new h({url:(c.WWW_HOST?window.location.protocol+"//"+c.WWW_HOST:"")+"/search/ss.php",suggestionParams:{isHeader:Number(K)},input:E,listItemHoverClass:"active",listFirstItemHover:false,dataType:"jsonp",createListContainer:function(){var V=$('<div class="m-search-suggest '+t+' hide"><ul class="mss-list"></ul></div>').appendTo("body");V.on("mouseenter",".mss-place .mss-title, .mss-place .mss-nav a",function(X){var W=$(X.currentTarget),Y=W.closest(".mss-place");Y.find(".mss-title").removeClass("active").removeClass("frozen").end().find(".mss-nav a").removeClass("active").end();W.addClass("active")}).on("mouseleave",".mss-place .mss-title, .mss-place .mss-nav a",function(X){var W=$(X.currentTarget);W.removeClass("active")});return V},handleSuggest:function(aB){i=aB.keyword;J=!!aB.is_hit;l="http://"+aB.www_host;var aw=aB.keyword_cut,ay=aB.show_types,W=aB.hide_types;var aq=$("<ul>");var aa=aB.first_poi;if(!!aa){var al=aa,aj=$('<li class="mss-item _j_listitem" data-type="poi">').appendTo(aq),ao=$('<div class="mss-title">').appendTo(aj);aj.attr("data-url",al.url);ao.append('<span class="mss-fr">'+(!!al.mddname?al.mddname:"")+al.typename+"</span>");ao.append('<span class="mss-cn">'+al.dis_name+"</span>")}var ag=aB.article_info;if(ag&&ag.result){for(var ar=0;ar<ag.result.length;ar++){var af=ag.result[ar],aj=$('<li class="mss-item _j_listitem" data-type="article_promoted">').appendTo(aq),ao=$('<div class="mss-title">').appendTo(aj);aj.attr("data-url",af.link);ao.html(af.name_display)}}var ak=aB.mdd_info;if(ak&&ak.result){for(var ar=0;ar<ak.result.length;ar++){var Z=ak.result[ar],aj=$('<li class="mss-item _j_listitem" data-type="mdd">').appendTo(aq),ao=$('<div class="mss-title">').appendTo(aj);aj.attr("data-url",Z.url);if(!!Z.parent){ao.append('<span class="mss-fr">'+Z.parent+"</span>")}ao.append('<span class="mss-cn">'+Z.dis_name+"</span>");ao.append('<span class="mss-gl"> '+Z.infoname+"</span>")}}var an=aB.hotel_info;if(an&&an.result&&!K){for(var ar=0;ar<an.result.length;ar++){var az=an.result[ar],aj=$('<li class="mss-item _j_listitem" data-type="hotel_promoted">').appendTo(aq),ao=$('<div class="mss-title">').appendTo(aj);aj.attr("data-url",az.url);ao.append('<span class="mss-fr">'+az.typename+"</span>");ao.append('<span class="mss-cn">'+az.title+"</span>");ao.append('<span class="mss-gl"> '+az.infoname+"</span>")}}var ad=aB.gl_info;if(ad&&ad.result){for(var ar=0;ar<ad.result.length;ar++){var ap=ad.result[ar],aj=$('<li class="mss-item _j_listitem" data-type="sales_gonglve">').appendTo(aq),ao=$('<div class="mss-title">').appendTo(aj);aj.attr("data-url",ap.url);ao.append('<span class="mss-fr">'+ap.typename+"</span>");ao.append('<span class="mss-cn">'+ap.title+"</span>")}}var Y=aB.sales_info;if(Y&&Y.result&&!K){for(var ar=0;ar<Y.result.length;ar++){var V=Y.result[ar],aj=$('<li class="mss-item _j_listitem" data-type="sales_promoted">').appendTo(aq),ao=$('<div class="mss-title">').appendTo(aj);aj.attr("data-url",V.url);ao.append('<span class="mss-fr">'+V.typename+"</span>");ao.append('<span class="mss-cn">'+V.title+"</span>");ao.append('<span class="mss-gl"> '+V.infoname+"</span>")}}var ae=aB.route_info;if(ae&&ae.result&&!K){for(var ar=0;ar<ae.result.length;ar++){var ax=ae.result[ar],aj=$('<li class="mss-item _j_listitem" data-type="route_promoted">').appendTo(aq),ao=$('<div class="mss-title">').appendTo(aj);aj.attr("data-url",ax.url);ao.append('<span class="mss-fr">'+ax.typename+"</span>");ao.append('<span class="mss-cn">'+ax.title+"</span>");ao.append('<span class="mss-gl"> '+ax.infoname+"</span>")}}var at=aB.qa_info;if(at&&at.result){for(var ar=0;ar<at.result.length;ar++){var ah=at.result[ar],aj=$('<li class="mss-item _j_listitem" data-type="wenda">').appendTo(aq),ao=$('<div class="mss-title">').appendTo(aj);aj.attr("data-url",ah.url);ao.append('<span class="mss-fr">'+ah.typename+"</span>");ao.append('<span class="mss-cn">'+ah.title+"</span>")}}var ac=aB.poi_info,av=!K;if(M.isArray(ay)&&M.indexOf(ay,"poi")!==-1){av=true}if(ac&&ac.result&&av){for(var ar=0;ar<ac.result.length;ar++){var al=ac.result[ar],X="hotel"===al.stype?"hotel":"poi",aj=$('<li class="mss-item _j_listitem" data-type="'+X+'">').appendTo(aq),ao=$('<div class="mss-title">').appendTo(aj);aj.attr("data-url",al.url);ao.append('<span class="mss-fr">'+(!!al.mddname?al.mddname:"")+al.typename+"</span>");ao.append('<span class="mss-cn" style="color:#999;">'+al.dis_name+"</span>")}}var ai=aB.sekey_info,au=K;if(M.isArray(W)&&M.indexOf(W,"sekey")!==-1){au=false}if(ai&&ai.result&&au){for(var ar=0;ar<ai.result.length;ar++){if(ar>4){break}var aA=ai.result[ar],aj=$('<li class="mss-item _j_listitem" data-type="sekey">').appendTo(aq);aj.attr("data-url",aA.url);aj.append('<div class="mss-title">'+aA.name+"</div>")}}var ab=aB.ginfo_num;if(!!ab){var aj=$('<li class="mss-item _j_listitem" data-type="info">').appendTo(aq);aj.append('<div class="mss-title">搜“<span class="mss-key">'+aw+'</span>”相关游记<span class="mss-num">'+ab+"篇</span></div>")}var am=aB.user_num;if(!!ab){var aj=$('<li class="mss-item _j_listitem" data-type="user">').appendTo(aq);aj.append('<div class="mss-title">搜“<span class="mss-key">'+aw+"</span>”相关用户</div>")}if(s>0){aq.find("._j_listitem").each(function(aC,aD){if(aC>s){$(aD).remove()}})}return aq.html()},updateList:function(V){this.listContainer.find(".mss-list").html(V);if(K){this.listContainer.find(".mss-list").addClass("shrink-list")}if(J){P.input.data("droplist").moveFocus(1)}}});if(n){var A=e("InputListener"),w=e("SuggestionXHR"),D=new w({URL:(c.WWW_HOST?"http://"+c.WWW_HOST:"")+"/search/s.php",dataType:"json"}),v=$("#_j_mfw_search_main"),U=E.closest(".search-wrapper"),L=$('<div class="search-keyword-tip"></div>').appendTo(U),B=C.input==="_j_index_search_input_all",G=false,u,q,N,k,r;A.listen(E,function(W){var V=$(W.target),X=$.trim(V.val());if(!G&&X){G=true}L.hide()});M.Event(P).on("before suggestion xhr",function(){var V=P.suggestionParams[P.keyParamName];if(V&&V!==y){D.getSuggestion({q:V,gall:1},$.proxy(function(X){var ab=$.trim(E.val());if(!ab){return false}if(!X||!X.keyword||(!X.result&&!X.unmatch)){return false}if(X.unmatch===1){L.hide()}else{y=V;if(U[0]){var Y=X.keyword.length,W=X.keyword.replace(/[A-Za-z0-9\s]/g,"").length,aa=Y-W;setTimeout(function(){L.html(X.keyword).css("left",32+W*14+aa*7).show()},1)}v.html($(X.result).css("minHeight",0).html());if(g&&b){v.find("> .wid").addClass("anim-climb");setTimeout(function(){v.find("> .wid").removeClass("anim-climb")},1)}var Z=c.search_type||"all";c.search_seid=Q(V,Z);c.search_keyword=V;c.is_search_cache=true;c.is_search_updated=true}},P))}})}M.Event(P).on("before suggestion xhr",function(){R(E,P.listContainer)});M.Event(P).on("before show list",function(){P.listContainer.find(".mss-list").show()});M.Event(P).on("itemfocused",function(W){var V=W.prevItem,X=W.focusItem,Y=P.listContainer;if(1<Y.find(".mss-place").length){if(X.hasClass("mss-place")){Y.find(".mss-place").removeClass("frozen")}if(!X.hasClass("mss-place")&&!!V&&V.hasClass("mss-place")){Y.find(".mss-place").removeClass("frozen");V.addClass("frozen")}}if(X.hasClass("mss-place")){X.find(".mss-title").addClass("frozen")}});M.Event(P).on("itemselected",function(X){var Z=X.item;if(Z.length){var Y=Z.data("type"),W=Z.data("url"),ab=E.attr("id")==="_j_head_search_input"?"header":"default";if(Y==="flight_hotel"||Y==="flight"||Y==="local"){Y="sales"}p=m(i,"all",ab,"suggest");if("info"===Y||"user"===Y){var aa=m(i,Y,ab,"suggest");location.href=l+"/search/s.php?q="+encodeURIComponent(i)+"&t="+Y+"&seid="+aa}else{var W=Z.data("url"),V=P.listContainer.find(".mss-item").index(Z.closest(".mss-item"))+1;O(W,V,Y);location.href=Z.data("url")}}else{if(i!==""){location.href=l+"/search/s.php?q="+encodeURIComponent(i)}}});var x=E.closest(".head-search-wrapper");if(x[0]){E.on("focus",function(V){setTimeout(function(){x.addClass("head-search-focus")},1)}).on("blur",function(V){setTimeout(function(){if(M.windowFocused){x.removeClass("head-search-focus")}},1)})}if(T&&T[0]){T.on("click",function(X){var W=$.trim(E.val());if(E.data("url")){if(E.data("url").indexOf("http")!==-1){location.href=E.data("url")}else{location.href=(c.WWW_HOST?"http://"+c.WWW_HOST:"")+E.data("url")}return true}if(W!==""){if(P.listContainer){P.listContainer.hide()}var Z=E.attr("id")==="_j_head_search_input"?"header":"default",aa=c.search_type||"all",Y=m(W,aa,Z,"form"),V=l+"/search/s.php?q="+encodeURIComponent(W);if(c.search_type&&location.pathname==="/search/s.php"){V+="&t="+c.search_type}V+="&seid="+Y;location.href=V}})}if(E&&E[0]){E.on("keydown",function(X){if(X.keyCode==13){var aa=P.input.data("droplist");if(aa&&aa.getFocusItem().length){return true}var W=$.trim(E.val());if(W!==""){if(P.listContainer){P.listContainer.hide()}var Z=E.attr("id")==="_j_head_search_input"?"header":"default",ab=c.search_type||"all",Y=m(W,ab,Z,"form"),V=l+"/search/s.php?q="+encodeURIComponent(W);if(c.search_type&&location.pathname==="/search/s.php"){V+="&t="+c.search_type}V+="&seid="+Y;location.href=V}}})}$(window).resize(function(){if(P.listContainer&&P.listContainer.length&&P.listContainer.is(":visible")){R(E,P.listContainer)}});$(window).on("scroll",function(V){if(z){P.hideDropList()}});function R(V,X){var W=V.offset();X.css({left:W.left+(C.input==="_j_index_search_input_all"?0:1),top:W.top+E.outerHeight()-2})}function m(V,Z,Y,X){var W={keyword:V,content_category:Z,searchbox_category:"main_search",searchbox_position:Y,search_type:X,version:d};return f.search(W)}function Q(V,X){var W={keyword:V,content_category:X,version:d};return f.searchCache(W)}function O(Y,W,X){var V={id:p,keyword:i,click_url:Y,index:W,content_category:X,search_type:"suggest",version:d};return f.resultClick(V)}function F(W,aa){var X=[],ac=W.split("|");aa=j(aa);for(var Z=0;Z<ac.length;Z++){var Y=$.trim(ac[Z]);if(Y=="search://"){var V=X.length;X[V]=ac[Z++];X[V+1]=ac[Z++];X[V+2]=ac[Z++];X[V+3]=ac[Z++];X[V+4]=ac[Z++];X[V+5]=ac[Z];continue}if(Y){try{Y=Y.replace(new RegExp(aa,"ig"),function(ad){return'<span class="highlight">'+ad+"</span>"})}catch(ab){Y=Y.replace(aa,function(ad){return'<span class="highlight">'+ad+"</span>"})}X[X.length]=Y}}return X}var o=$("<div/>");function j(V){return o.text(V).html()}};return a});M.closure(function(c){var r=$("#header");if(!r.length){return false}var o=c("/js/Dropdown");var n=c("/js/SiteSearch");new n({input:"_j_head_search_input",submit:"_j_head_search_link",isRelevant:true});$("#_j_nav_sales").find("[data-sales-nav]").on("click",function(){var t=$(this).data("salesNav");mfwPageEvent("sales","index_sales_nav",{name:t})});if(!window.showBarFlag){$("._j_sales_nav_show").off("hover")}else{var b=0,p=0;$("._j_sales_nav_show").hover(function(){clearTimeout(b);p=setTimeout(function(){$("._j_sales_nav_show").addClass("head-nav-hover");$("._j_sales_top").fadeIn(300)},200)},function(){clearTimeout(p);b=setTimeout(function(){$("._j_sales_nav_show").removeClass("head-nav-hover");$("._j_sales_top").fadeOut(300)},200)})}var m=0,f=0;$("._j_shequ_nav_show").hover(function(){clearTimeout(m);f=setTimeout(function(){$("._j_shequ_nav_show").addClass("head-nav-hover");$("._j_shequ_top").fadeIn(300)},200)},function(){clearTimeout(f);m=setTimeout(function(){$("._j_shequ_nav_show").removeClass("head-nav-hover");$("._j_shequ_top").fadeOut(300)},200)});var q=$("#_j_community_panel"),i=q.find(".panel-image").length,j=Math.floor(Math.random()*i);if(j===i){j--}q.find(".panel-image").eq(j).show();$("#_j_showlogin").click(function(t){if(window.location.host===Env.WWW_HOST){t.preventDefault()}M.Event.fire("login:required")});var g=window.location.hostname,k=window.location.pathname+window.location.search,a=$("#_j_head_nav");if(g.indexOf("www")===0){if(k===""||k==="/"){a.children("li:eq(0)").addClass("head-nav-active")}var h=new RegExp("^/(mdd|photo/mdd|poi|photo/poi|travel-scenic-spot|jd|cy|gw|yl|yj|xc|baike)/|sFrom=mdd.*|sFrom=smdd.*","i");if(h.test(k)){a.children("li:eq(1)").addClass("head-nav-active")}var e=new RegExp("^/gonglve/.*","i");if(e.test(k)){a.children("li:eq(2)").addClass("head-nav-active")}var d=window.Env&&window.Env.sales_title_tag;if(d){if(d==="flight_hotel"){a.children("li:eq(3)").find("ul>li:eq(0)>a").addClass("on")}else{if(d==="visa"){a.children("li:eq(3)").find("ul>li:eq(2)>a").addClass("on")}else{if(d==="localdeals"){a.children("li:eq(3)").find("ul>li:eq(1)>a").addClass("on")}else{if(d==="insurance"){a.children("li:eq(3)").find("ul>li:eq(4)>a").addClass("on")}}}}a.find("li:eq(3)").addClass("head-nav-active")}if(/^\/insurance\//i.test(k)){a.find("li:eq(3)").addClass("head-nav-active")}var s=new RegExp("^/hotel/(?!.*sFrom=mdd).*","ig");if(s.test(k)){a.children("li:eq(4)").addClass("head-nav-active");a.children("li:eq(4)").find(".head-act616").remove()}var l=new RegExp("^/(wenda|qa|mall|together|group|i|traveller|rudder|paimai|club|postal|school|photo_pk|focus)/(?!.*sFrom=mdd|s.php*).*","i");if(l.test(k)){a.children("li:eq(5)").addClass("head-nav-active")}}});M.define("/sales_order/js/pagelet/BookingErrorStaH5",function(a){return{init:function(){this.staError()},staError:function(){window.onerror=function(d,f,h,c,b){try{mfwPageEvent("sales","order_booking_busi_error",({uid:window.Env.params.uid,url:window.location.href,message:d,source:f,lineno:h,colno:c,error:b}))}catch(g){}}}}});M.define("/js/sales/tool/StringCheck",function(a){return{sFilterN:function(c){try{mfwPageEvent("sales","code:remove",({busi:"common","function":"/js/sales/tool/StringCheck->sFilterN",}))}catch(b){}if(c&&c.length>0){return c.replace(/^\s+|\s+$/gm,"")}return""},iDateContrast:function(c,d){var e=new Date(c.replace(/-/g,"/")).getTime(),b=new Date(d.replace(/-/g,"/")).getTime();if(isNaN(e)&&isNaN(b)){return 0}else{if(isNaN(e)){return 1}else{if(isNaN(b)){return -1}}}if(b>e){return 1}else{if(b===e){return 0}else{return -1}}},bCommonSymbolsVaild:function(){var c=0,b=10000;if(arguments[1]){c=arguments[1]}if(arguments[2]){b=arguments[2]}var d=new RegExp("^[A-Za-z0-9]{"+c+","+b+"}$","i");return d.test(arguments[0])},bChineseNameVaild:function(b){return this.bChineseLenVaild(b,2,10)},bChineseLenVaild:function(c,d,b){var e=new RegExp("^[\\u4e00-\\u9fa5·]{"+d+","+b+"}$","i");return e.test(c)},bNoChineseLenVaild:function(c,d,b){var f=new RegExp("[\\u4e00-\\u9fa5]+","i"),e=new RegExp("^.{"+d+","+b+"}$","i");if(f.test(c)){return false}return e.test(c)},bEnglishLenVaild:function(c,d,b){var e=new RegExp("^[A-Za-z0-9_\\s]{"+d+","+b+"}$","i");return e.test(c)}}});M.define("/js/sales/tool/CodeCheck",function(a){return{bIdentityValid:function(k){if(typeof k!=="string"){return false}k=k.toUpperCase();var f={11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",21:"辽宁",22:"吉林",23:"黑龙江 ",31:"上海",32:"江苏",33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",42:"湖北 ",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",51:"四川",52:"贵州",53:"云南",54:"西藏 ",61:"陕西",62:"甘肃",63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外"};var n=k.substr(6,4)+"/"+Number(k.substr(10,2))+"/"+Number(k.substr(12,2));var j=new Date(n);var o=j.getFullYear()+"/"+Number(j.getMonth()+1)+"/"+Number(j.getDate());var c=new Date().getTime();var e=j.getTime();var l=[7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2];var m=["1","0","X","9","8","7","6","5","4","3","2"];var h=0,g,b;if(!/^\d{17}(\d|x)$/i.test(k)){return false}if(f[k.substr(0,2)]===undefined){return false}if(e>=c||n!==o){return false}for(g=0;g<17;g++){h+=k.substr(g,1)*l[g]}b=m[h%11];if(b!==k.substr(17,1)){return false}return true},bWeixinVaild:function(b){var c=/^[a-z\d\-_]*$/i;return c.test(b)},bEmailVaild:function(b){var c=/^[\da-z\-\._]+@[\da-z]+[\da-z\-\.]*?\.[a-z]+$/i;return c.test(b)},bSpecialEmailVaild:function(b,d){var c=new RegExp("^[\\da-z\\-\\._]+@"+d+"$","i");return c.test(b)},bTelVaild:function(b){var c=/^[\d\-\+\(\)\*#]*$/;return c.test(b)},bMainlandPhoneValid:function(b){var c=/^1[0-9]{10}$/;return c.test(b)},bIntvalVaild:function(c){var b=/^[0-9]*$/;return b.test(c)},bIsIphoneX:function(){if(navigator&&navigator.userAgent&&screen&&screen.width&&screen.height){var b=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(b&&screen.width*3==1125&&screen.height*3===2436){return true}}return false}}});M.define("/sales_order/js/pagelet/BookingTemplateIntegrity",function(a){var d=a("/js/sales/tool/StringCheck"),b=a("/js/sales/tool/CodeCheck");var c={check:function(f,e,g,h){if(typeof g==="number"){g=g+""}else{if(typeof g==="string"){}else{g=""}}if(h&&g.length===0){return false}if(g.length>0){switch(f){case 0:return this.checkStrIntegrity(e,g);break;case 1:return this.checkChineseIntegrity(e,g);break;case 2:return this.checkEnglishIntegrity(e,g);break;case 3:return this.checkTelIntegrity(g);break;case 4:return this.checkIntNumIntegrity(e,g);break;case 5:return this.checkDateIntegrity(e,g);break;case 6:return this.checkTimeIntegrity(e,g);break;case 7:return this.checkIntNumberIntegrity(e,g);break;case 8:return this.checkIdentityIntegrity(g);break;case 9:return this.checkUploaderPictureIntegrity(e,g);break;case 10:return this.checkMainlandPhoneIntegrity(g);break;default:return this.checkStrIntegrity(e,g);break}}return true},checkStrIntegrity:function(e,g){var f=this.getIntervalNum(e);if(g.length<f.min||g.length>f.max){return false}return true},checkChineseIntegrity:function(e,g){var f=this.getIntervalNum(e);if(!d.bChineseLenVaild(g,f.min,f.max)){return false}return true},checkEnglishIntegrity:function(e,g){var f=this.getIntervalNum(e);if(!d.bNoChineseLenVaild(g,f.min,f.max)){return false}return true},checkTelIntegrity:function(e){if(!b.bTelVaild(e)){return false}return true},checkMainlandPhoneIntegrity:function(e){return !!b.bMainlandPhoneValid(e)},checkIdentityIntegrity:function(e){if(!b.bIdentityValid(e)){return false}return true},checkUploaderPictureIntegrity:function(e,h){var g=0,f=this.getIntervalNum(e);if(h&&h.length){var i=h.split(",");g=i.length}if(g<f.min||g>f.max){return false}return true},checkIntNumIntegrity:function(e,g){var f=this.getIntervalNum(e);if(!b.bIntvalVaild(g)||g<f.min||g>f.max){return false}return true},checkIntNumberIntegrity:function(e,g){var f=this.getIntervalNum(e);if(!b.bIntvalVaild(g)||g.length<f.min||g.length>f.max){return false}return true},checkDateIntegrity:function(e,g){var f=this.getIntervalDate(e);if(d.iDateContrast(g,f.min)===1||d.iDateContrast(f.max,g)===1){return false}return true},checkTimeIntegrity:function(e,g){g="1970/01/01 "+g;var f=this.getIntervalTime(e);if(d.iDateContrast(g,f.min)===1||d.iDateContrast(f.max,g)===1){return false}return true},getIntervalDate:function(f){var e={min:"0000-00-00",max:"2100-01-01"};if(typeof f==="object"){if(f.min){e.min=f.min}if(f.max){e.max=f.max}}else{if(f>0){e.min=f;e.max=f}}return e},getIntervalNum:function(f){var e={min:0,max:10000};if(typeof f==="object"){if(f.min){e.min=f.min}if(f.max){e.max=f.max}}else{if(f>0){e.min=f;e.max=f}}return e},getIntervalTime:function(f){var e={min:"1900-01-01 00:00:00",max:"2100-01-01 00:00:00"};if(typeof f==="object"){if(f.min){e.min="1970/01/01 "+f.min}if(f.max){e.max="1970/01/01 "+f.max}}return e}};return c});M.define("/js/sales/tool/StringFilter",function(a){return{sFilterN:function(b){if(typeof b==="string"){return b.replace(/^\s+|\s+$/gm,"")}return b}}});M.define("/sales_order/js/pagelet/BookingTemplateBase",function(b){var d=b("/sales_order/js/pagelet/BookingTemplateIntegrity"),a=b("/js/sales/tool/StringFilter");var c=function(){};M.mix(c.prototype,{checkInput:function(i,l){var f=i.data("limit"),e=i.data("limit_value"),h=i.data("notice"),k=l>0?0:i.data("required"),j=this.getInputVal(i);var g=d.check(f,e,j,k);return{m:h,b:g}},getInputVal:function(e){if(this.bDataSaveOrigin(e)){return a.sFilterN(e.val())}if(typeof e.data("val")==="undefined"){return""}return e.data("val")},renderInputList:function(){if(this.template&&this.template.length){this.template.forEach($.proxy(function(e){if(e.group==="single"){this.renderInputSingle(e)}else{if(e.group==="uploader"){this.renderInputImageUploader(e)}else{this.renderInputComposite(e)}}},this))}},getStructById:function(e,g){if(e&&e.id&&e.id==="f100"){return{id:g,name:g}}var f={};if(e&&e.value&&e.value.length){e.value.forEach(function(h){if(h.id==g){f=h}})}return f},replaceInput:function(e,g){var f=this.setInput(g);e.after(f);e.remove();return f},setInput:function(g){var f=this.getInputTmpl(),e=$.tmpl(f,g);e.data("limit_value",g.limit_value).data("default_value",g.default_value).data("template",g).data("ext",g.ext).data("value",g.value);return e},bDataSaveOrigin:function(e){if(e.data("use_value")==="origin"){return true}return false},setExtTemplate:function(){var e=[];if(this.template&&this.template.length>0){this.template.forEach(function(g){if(g.group=="composite"&&g.ext&&typeof g.ext==="object"){for(var f in g.ext){e.push(g.ext[f])}}})}this.ext_template=e}});return c});M.define("/sales_order/js/pagelet/BookingChoose",function(a){a("jq-tmpl");var b=function(c,d){this.inputDom=c;this.list=d;this.container=null;this.confirmCallback=$.noop;this.init()};M.mix(b.prototype,{init:function(){this.initDom()},initDom:function(){if(this.inputDom&&this.inputDom.length){var c='<div class="drop-list" style="max-height: 500px; overflow: auto;">\n<ul class="_j_ti_select_list"></ul></div>';this.container=$.tmpl(c);this.setList(this.list);this.inputDom.after(this.container);this.bindEvent()}},confirmResult:function(){var c={id:"",name:""};this.container.find("._j_bs_choose.selected").each(function(){var d=$(this);c.id=d.data("key");c.name=d.data("name");return false});this.confirmCallback(c);this.hide()},bindEvent:function(){if(this.container){this.container.on("click","._j_bs_choose",$.proxy(function(c){var d=$(c.currentTarget);this.chooseOne(d,1)},this));$("body,html").on("click",$.proxy(function(d){var e=$(d.target),c=e.closest("._j_template_atom_container");if(c.length){}else{this.hide()}},this))}},chooseOne:function(d,c){if(d){if(!d.hasClass("selected")){this.container.find("._j_bs_choose").removeClass("selected");d.addClass("selected");if(c){this.confirmResult()}}else{if(c){this.confirmResult()}}}},setList:function(e){var c='<div><li class="_j_bs_choose" data-key="${id}" data-name="${name}">${name}</li></div>',d="";if(e&&e.length>0){e.forEach(function(f){d+=$.tmpl(c,f).html()})}this.container.find("._j_ti_select_list").html(d)},choose:function(d){var c=this.container.find("._j_bs_choose[data-key='"+d+"']");this.chooseOne(c,0)},show:function(){if(this.container){this.container.show()}},hide:function(){if(this.container){this.container.hide()}},confirm:function(c){this.confirmCallback=typeof c=="function"?c:$.noop}});return b});M.define("/sales_order/js/pagelet/BookingTpl",function(a){a("jq-tmpl");var d=a("/sales_order/js/pagelet/BookingTemplateBase"),b=a("/sales_order/js/pagelet/BookingChoose");var c=function(f,e){this.template=f;this.setExtTemplate();this.target=null;this.listTarget=null;this.container=e;this.initTpl=false;this.init()};M.mix(c.prototype,{bindEvent:function(){this.container.on("click",'._j_template_input[data-use="1"]',$.proxy(function(e){var g=$(e.currentTarget),i=g.data("pop"),h=this.getInputVal(g),f=g.data("value");if(!i){i=new b(g,f);i.confirm($.proxy(function(j){this.setInputData(g,j.id)},this));g.data("pop",i)}i.choose(h);i.show()},this)).on("click",'._j_template_input[data-use="3"]',$.proxy(function(f){var h=$(f.currentTarget),j=h.data("pop"),e=h.data("ext"),g=h.data("value"),i=this.getInputVal(h);if(!j){j=new b(h,g);j.confirm($.proxy(function(k){if(e[k.id]){h.parents("._j_template_atom_container").find("._j_template_error").text("请输入正确的"+k.name);this.replaceInput(h.next().next(),e[k.id]);this.setInputData(h,k.id)}},this));h.data("pop",j)}j.choose(i);j.show()},this)).on("click","._j_template_error",$.proxy(function(e){var g=$(e.currentTarget),f=g.parents("._j_template_atom_container");g.hide().removeClass("show");f.find("._j_template_input").trigger("focus")},this)).on("click","._j_template_name",$.proxy(function(e){var g=$(e.currentTarget),f=g.parents("._j_template_atom_container");f.removeClass("form-sec-focus").addClass("form-sec-active");f.find("._j_template_input").focus()},this)).on("focus","._j_template_input",$.proxy(function(e){var g=$(e.currentTarget),f=g.parents("._j_template_atom_container");f.removeClass("form-sec-focus").addClass("form-sec-active")},this)).on("blur","._j_template_input",$.proxy(function(e){if(this.confirmCallback&&typeof this.confirmCallback==="function"){if(this.checkInputList(true)){var f=this.getData();this.confirmCallback(this.listTarget,this.target,f)}}},this)).on("blur","._j_template_input",$.proxy(function(e){var g=$(e.currentTarget),i=this.getInputVal(g),f=g.parents("._j_template_atom_container");f.removeClass("form-sec-active");if(typeof i==="string"&&i.length>0){f.addClass("form-sec-focus")}if(g.parents("._j_template_composite_inner").length>0){f.addClass("form-sec-focus");var h=f.find("._j_template_input:eq(1)");if(h&&h.length){if(h.val().length){h.css("border","1px solid #e5e5e5")}else{h.css("border-left","1px solid #ef523d")}}}},this))},init:function(){this.initDom();this.bindEvent();this.initDateTime()},initDom:function(){if(!this.initTpl){this.initTpl=true;this.renderInputList()}},initDateTime:function(){this.container.find("._j_template_input").each(function(e,g){var f=$(g);if(f.data("use")==6){f.datetimepicker({timepicker:false,lang:"zh",format:"Y-m-d",scrollMonth:false,scrollInput:false,showApplyButton:false,initTime:false,defaultSelect:false,theme:"mfw",yearStart:1900,yearEnd:2050})}else{if(f.data("use")==7){f.datetimepicker({datepicker:false,format:"H:i"})}}})},renderInputSingle:function(h){if(h){var e=this.getInputSingleTmpl(),g={name:h.name,notice:h.notice},i=$.tmpl(e,g);var f=this.setInput(h);i.find("._j_template_name").after(f);if(h.hide){i.hide()}this.setInputData(f,"");this.container.append(i)}},renderInputComposite:function(i){var e={};if(i.ext&&i.ext.length&&i.ext[0]){e=i.ext[0]}var f=this.getInputCompositeTmpl(),h={name:i.name,notice:i.notice},j=$.tmpl(f,h);var l=this.setInput(i),g=this.setInput(e);j.find("._j_template_composite_inner").append(l);this.setInputData(l,"");j.find("._j_template_composite_inner").append(g);if(i.default_value&&i.default_value.id&&i.ext){var k=this.replaceInput(g,i.ext[i.default_value.id]);this.setInputData(k,"")}this.container.append(j)},getInputSingleTmpl:function(){var e='<div class="form-sec flt1 _j_template_atom_container"><label class="_j_template_name">${name}</label><label class="notFail _j_template_error" style="display: none"><i></i>${notice}</label></div>';return e},getInputCompositeTmpl:function(){var e='<div class="form-sec flt1 _j_template_atom_container"><label class="_j_template_name">${name}</label><div class="ipt-two"><div class="_j_template_composite_inner"></div><label class="notFail _j_template_error" style="display: none"><i></i>${notice}</label></div></div>';return e},getInputTmpl:function(){return'<input class="template-field _j_template_input {{if required}}bord-red{{/if}}" type="${type}" data-limit="${limit}" data-use="${use}" {{if forbid}}readonly="readonly"{{/if}} name="${id}" data-required="${required}" data-hide="${hide}" data-notice="${notice}" data-use_value="${use_value}" value="" placeholder="${placeholder}">'},setInputData:function(e,h){var g=e.data("template");if(this.bDataSaveOrigin(e)){h=h+"";if(h&&h.length){e.val(h)}else{if(g){e.val(g.default_value)}}}else{var i=this.getStructById(g,h);if(i&&i.name&&i.name.length){e.data("val",i.id);e.val(i.name)}else{if(g&&g.default_value&&typeof g.default_value==="object"&&g.default_value.hasOwnProperty("id")){e.data("val",g.default_value.id)}else{e.data("val","")}if(g&&g.default_value&&typeof g.default_value==="object"&&g.default_value.hasOwnProperty("name")){e.val(g.default_value.name)}else{e.val("")}}}if(e&&e.val){e.removeClass("form-sec-active");var f=e.val();if(f.length>0||e.parents("._j_template_composite_inner").length>0){var k=e.parents("._j_template_atom_container"),j=k.find("._j_template_input:eq(1)");k.addClass("form-sec-focus");if(j&&j.length){if(j.data("required")){if(!j.val().length){j.css("border-left","1px solid #ef523d")}else{j.css("border","1px solid #e5e5e5")}}}}else{e.parents("._j_template_atom_container").removeClass("form-sec-focus")}}},emptyError:function(){this.container.find("._j_template_error").hide().removeClass("hide")},setInputDataOrg:function(e,f){this.setInputData(e,f)},setList:function(h,i,g){this.target=i;this.listTarget=g;if(this.template&&this.template.length>0){this.template.forEach(function(j){if(!h.hasOwnProperty(j.id)){h[j.id]=j.default_value}})}if(this.ext_template&&this.ext_template.length>0){this.ext_template.forEach(function(j){if(!h.hasOwnProperty(j.id)){h[j.id]=j.default_value}})}if(h){for(var f in h){var e=this.container.find('._j_template_input[name="'+f+'"]');if(e&&e.length){this.setInputDataOrg(e,h[f])}}}this.container.data("change",0);this.emptyError()},setTarget:function(e){this.target=e},checkInputList:function(){var f=true,e=arguments;this.container.find("._j_template_input").each($.proxy(function(j,l){var k=$(l),h=k.parents("._j_template_atom_container"),g=this.checkInput(k);if(!g.b){if(!e||!e[0]){h.removeClass("form-sec-active");if(!k.parents("._j_template_composite_inner").length>0){h.removeClass("form-sec-focus")}h.find("._j_template_error").show().addClass("show")}f=false}},this));return f},getData:function(){var e={};this.container.find("._j_template_input").each($.proxy(function(g,k){var h=$(k),f=h.attr("name"),j=this.getInputVal(h);e[f]=j},this));return e},virtualConfirm:function(e){this.confirmCallback=typeof e=="function"?e:$.noop}});M.extend(c,d);return c});M.define("dialog/Layer",function(a){var g=0,f=550,d=(function(){return $.browser&&$.browser.msie&&parseInt($.browser.version,10)==7}()),c=(function(){return $.browser&&$.browser.msie&&parseInt($.browser.version,10)<7}());function b(){return g++}function e(h){this.opacity=0.8;this.background="#fff";this.impl="Dialog";this.fixed=true;M.mix(this,h);this.id="_j_layer_"+b();this.stacks=[];this.activeStackId=null;this.overflow=false;this.changeFixed=false;e.instances[this.id]=this;if(!e[this.impl]){e[this.impl]=[]}e[this.impl].push(this.id);this.init()}e.prototype={init:function(){this._createPanel()},_createPanel:function(){f++;var h={position:(!c&&this.fixed)?"fixed":"absolute",width:"100%",height:"100%",top:0,left:0},j=M.mix({},h,{"z-index":f,display:"none"}),k=M.mix({},h,{position:!c?"fixed":"absolute",background:this.background,opacity:this.opacity,"z-index":-1}),i=M.mix({},h,{"z-index":0},(!c&&this.fixed)?{"overflow-x":"hidden","overflow-y":"hidden"}:{overflow:"visible"});this._panel=$('<div id="'+this.id+'" class="layer _j_layer">                                <div class="layer_mask _j_mask"></div>                                <div class="layer_content _j_content"></div>                            </div>').css(j).appendTo("body");this._mask=this._panel.children("._j_mask").css(k);this._content=this._panel.children("._j_content").css(i)},setZIndex:function(h){f=h;this._panel.css("z-index",f)},getZIndex:function(){return +this._panel.css("z-index")},toFront:function(){this.setZIndex(f+1)},setFixed:function(h){h=!!h;if(this.fixed!=h){this.changeFixed=true;this.fixed=h;if(!c&&this.fixed){this._panel.css("position","fixed");this._content.css({position:"fixed","overflow-x":"hidden","overflow-y":"hidden"})}else{this._panel.css("position","absolute");this._content.css({position:"absolute","overflow-x":"","overflow-y":"",overflow:"visible"})}}else{this.changeFixed=false}},newStack:function(i){var h=$(i).appendTo(this._content);this.stacks.push(h);return this.stacks.length-1},getStack:function(h){return this.stacks[h]},getActiveStack:function(){return this.stacks[this.activeStackId]},setActiveStack:function(h){this.activeStackId=h},getPanel:function(){return this._panel},getMask:function(){return this._mask},getContent:function(){return this._content},show:function(j){var i=this;if(this.visible){typeof j==="function"&&j();return}e.activeId=this.id;this.visible=true;if(c){var h=document.documentElement&&document.documentElement.scrollHeight||document.body.scrollHeight;this._panel.css("height",h);this._mask.css("height",h)}this._panel.fadeIn(200,function(){typeof j==="function"&&j()})},hide:function(i){var h=this;if(!this.visible){typeof i==="function"&&i();return}this.visible=false;if(c){this._panel.css("height","");this._mask.css("height","")}this._panel.fadeOut(200,function(){typeof i==="function"&&i();h._recoverTopScroller()})},setOverFlow:function(h){this.overflow=h;if(h){if(!c&&this.fixed){this._hideTopScroller();this._content.css("overflow-y","auto")}}else{if(!c&&this.fixed){this._content.css("overflow-y","hidden")}}},_hideTopScroller:function(){if(d){$("html").css("overflow","hidden")}else{if(!c){$("body").css("overflow","hidden")}else{$("body").css("overflow-x","hidden");this._panel.height($(document).height()+20)}}},_recoverTopScroller:function(){if(d){$("html").css("overflow","")}else{if(!c){$("body").css("overflow","")}else{$("body").css("overflow-x","")}}},destroy:function(){this.hide($.proxy(function(){this._panel&&this._panel.remove();this._panel=null;if(M.indexOf(e[this.impl],this.id)!=-1){e[this.impl].splice(M.indexOf(e[this.impl],this.id),1)}delete e.instances[this.id]},this))},clear:function(){this._content.empty();this.stacks=[];this.activeStackId=null}};e.instances={};e.activeId=null;e.getInstance=function(h){return e.instances[h]};e.getActive=function(h){var i=e.getInstance(e.activeId);if(h&&i){i=i.impl===h?i:null}return i};e.getImplInstance=function(i){var h=e.getActive(i);if(!h&&M.is(e[i],"Array")&&e[i].length){h=e.getInstance(e[i][e[i].length-1])}return h};e.closeActive=function(){var h=e.getActive();if(h&&h.getActiveStack()){h.getActiveStack().trigger("close")}};$(document).keyup(function(h){if(h.keyCode==27){e.closeActive()}});$(document).unload(function(){M.forEach(e.instances,function(){e.destroy()})});return e});M.define("dialog/DialogBase",function(b){var e=b("dialog/Layer"),a=M.Event,d=(function(){return $.browser&&$.browser.msie&&parseInt($.browser.version,10)<7}());function c(f){this.newLayer=false;this.width="";this.height="";this.background="#000";this.panelBackground="#fff";this.bgOpacity=0.7;this.stackable=true;this.fixed=true;this.reposition=false;this.autoPosition=true;this.minTopOffset=20;this.layerZIndex=-1;this.impl="Dialog";M.mix(this,f);this.visible=false;this.destroyed=false;this.positioned=false;this.resizeTimer=0;this.init()}c.prototype={tpl:"<div />",init:function(){this._createDialog();this._bindEvents()},_createDialog:function(){this._panel=$(this.tpl).css({position:"absolute",opacity:0,display:"none",background:this.panelBackground,"z-index":0});this.setRect({width:this.width,height:this.height});this._layer=!this.newLayer&&e.getImplInstance(this.impl)||new e({impl:this.impl});if(this.layerZIndex>=0){this._layer.setZIndex(this.layerZIndex)}this._layer.setFixed(this.fixed);this._layer.getMask().css({background:this.background,opacity:this.bgOpacity});this._stackId=this._layer.newStack(this._panel);this.setPanelContent()},_bindEvents:function(){var f=this;$(window).resize($.proxy(this.resizePosition,this));M.Event(this).on("resize",$.proxy(this.resizePosition,this));this._panel.delegate("._j_close, a[data-dialog-button]","click",function(g){var h=$(g.currentTarget).attr("data-dialog-button");if(h=="hide"){f.hide()}else{f.close()}g.preventDefault()});this._panel.bind("close",function(g,h){f.close(h)})},resizePosition:function(){var f=this;clearTimeout(this.resizeTimer);if(f.visible&&f.autoPosition){this.resizeTimer=setTimeout(function(){f.setPosition()},100)}},addClass:function(f){this._panel.addClass(f)},removeClass:function(f){this._panel.removeClass(f)},setRect:function(f){if(f.width){this._panel.css("width",f.width);this.width=f.width}if(f.height){this._panel.css("height",f.height);this.height=f.height}},getPanel:function(){return this._panel},getLayer:function(){return this._layer},getMask:function(){return this._layer&&this._layer.getMask()},setPanelContent:function(){},_getPanelRect:function(){var f=this.getPanel(),g=f.outerHeight(),h=f.outerWidth();if(!f.is(":visible")){f.css({visibility:"hidden",display:"block"});var g=f.outerHeight(),h=f.outerWidth();f.css({visibility:"",display:""})}return{height:g,width:h}},_getNumric:function(f){f=parseInt(f,10);return isNaN(f)?0:f},setPosition:function(f){var g=this._getPanelRect(),h={width:$(window).width(),height:$(window).height()};var k=(h.width-(this._getNumric(this.width)>0?this._getNumric(this.width):g.width))/2,j=(h.height-(this._getNumric(this.height)>0?this._getNumric(this.height):g.height))*4/9;j=j<this.minTopOffset?this.minTopOffset:j;if(d||!this.fixed){var i=$(window).scrollTop();if(i>0){j+=i}}f={left:(f&&f.left)||k,top:(f&&f.top)||j};if(!d&&this.fixed){if(h.height-g.height<=f.top){this.getPanel().addClass("dialog_overflow");this._layer.setOverFlow(true)}else{this.getPanel().removeClass("dialog_overflow");this._layer.setOverFlow(false)}}var l=this.positioned?"animate":"css";$.fn[l].call(this.getPanel(),f,200);this.positioned=true;this.position=f},setFixed:function(f){this.fixed=!!f;this._layer.setFixed(this.fixed)},getPosition:function(){return this.position},show:function(f){if(this.visible){return}var h=this;a(this).fire("beforeshow");var g;if(this._layer.getActiveStack()){g=this._layer.getActiveStack();if(!this.reposition&&!f&&!this._layer.changeFixed){f=this._layer.getActiveStack().position()}}this._layer.show();this.getPanel().css({display:"","z-index":1});this.setPosition(f);g&&g.trigger("close",[true]);this.visible=true;this._layer.setActiveStack(this._stackId);this.getPanel().animate({opacity:1},{queue:false,duration:200,complete:function(){a(h).fire("aftershow")}})},close:function(){var f=this.stackable?"hide":"destroy";this[f].apply(this,Array.prototype.slice.call(arguments))},hide:function(g,f){if(typeof g=="function"){f=g;g=undefined}if(!this.visible){typeof f=="function"&&f();return}a(this).fire("beforeclose");a(this).fire("beforehide");this._layer.setActiveStack(null);this.visible=false;if(!g){this._layer.hide()}this.getPanel().animate({opacity:0},{queue:false,duration:200,complete:$.proxy(function(){this.getPanel().css({display:"none","z-index":0});a(this).fire("afterhide");a(this).fire("afterclose");typeof f=="function"&&f()},this)})},destroy:function(g,f){if(typeof g=="function"){f=g;g=undefined}if(this.destroyed){M.error("Dialog already destroyed!");typeof f=="function"&&f();return}a(this).fire("beforeclose");a(this).fire("beforedestroy");this.destroyed=true;this.hide(g,$.proxy(function(){if(this._panel.length){this._panel.undelegate();this._panel.unbind();this._panel.remove();this._panel=null}this._layer=null;a(this).fire("afterdestroy");a(this).fire("afterclose");typeof f=="function"&&f()},this))}};return c});M.define("dialog/Dialog",function(c){var d=c("dialog/DialogBase"),a='<div class="popup-box layer_dialog _j_dialog pop_no_margin">                    <div class="dialog_title" style="display:none"><div class="_j_title title"></div></div>                    <div class="dialog_body _j_content"></div>                    <a id="popup_close" class="close-btn _j_close"><i></i></a>                </div>';var b=M.extend(function(e){this.content="";this.title="";this.PANEL_CLASS="";this.MASK_CLASS="";b.$parent.call(this,e)},d);M.mix(b.prototype,{tpl:a,setPanelContent:function(){this._dialogTitle=this._panel.find("._j_title");this._dialogContent=this._panel.find("._j_content");this.setTitle(this.title);this.setContent(this.content);this.addClass(this.PANEL_CLASS);this.getMask().addClass(this.MASK_CLASS)},setTitle:function(e){if(e){this._dialogTitle.html(e).parent().css("display","")}else{this._dialogTitle.parent().css("display","none")}this.title=e},getTitle:function(){return this.title},setContent:function(e){this._dialogContent.empty().append(e)}});return b});M.define("dialog/alert",function(e,d){var b=e("dialog/Dialog"),a='<div id="popup_container" class="popup-box new-popbox"><a class="close-btn _j_close"><i></i></a><div class="pop-ico" id="_j_alertpopicon"><i class="i1"></i></div><div class="pop-ctn"><p class="hd _j_content"></p><p class="bd _j_detail"></p></div><div class="pop-btns"><a role="button" tabindex="0" class="popbtn popbtn-submit _j_close">&nbsp;确定&nbsp;</a></div></div>',f=M.extend(function(j){var i={width:420,content:"请输入内容",background:"#000",bgOpacity:0.7,PANEL_CLASS:"pop_no_margin",reposition:true,impl:"Alert",layerZIndex:10000};j=M.mix(i,j);f.$parent.call(this,j);this.bindEvents()},b),g=null,h=$.noop;M.mix(f.prototype,{tpl:a,setAlertTitle:function(i){this.setContent(i)},setAlertContent:function(i){this.getPanel().find("._j_detail").text(i)},setAssureWords:function(i){this.getPanel().find(".popbtn-submit").text(i)},setCloserHide:function(i){if(i){this.getPanel().find(".close-btn").hide()}else{this.getPanel().find(".close-btn").show()}},bindEvents:function(){var i=this.getPanel();i.on("keydown",".pop-btns ._j_close",function(j){if(j.keyCode==13){$(this).trigger("click")}}).on("click",".pop-btns ._j_close",function(j){i.data("btn_trigger",true)})}});var c=function(i,k,j){if(!g){g=new f();M.Event(g).on("afterhide",function(){var l=g.getPanel();if(typeof h=="function"){h.call(g,l)}l.data("btn_trigger",false)});M.Event(g).on("aftershow",function(){g.getPanel().find(".pop-btns ._j_close").focus()})}g.getLayer().toFront();if(M.isObject(i)){g.setAlertTitle(i.title);g.setAlertContent(i.content)}else{g.setAlertTitle(i);g.setAlertContent("")}if(M.isObject(i)){if(i.assureWords){g.setAssureWords(i.assureWords)}else{g.setAssureWords("确定")}if(i.hideCloser){g.setCloserHide(true)}else{g.setCloserHide(false)}}else{g.setAssureWords("确定");g.setCloserHide(false)}if(typeof k=="function"){h=k}else{h=$.noop}if(j){$("#_j_alertpopicon").children("i").attr("class","i"+j)}else{$("#_j_alertpopicon").children("i").attr("class","i"+1)}g.show();return g};d.pop=c;d.warning=function(i,j){c(i,j,1)};d.tip=function(i,j){c(i,j,3)}});M.define("/sales_order/js/pagelet/BookingConsistency",function(b){var a=function(c){this.resources_id=c;this.send_number=0;this.receive_number=0};M.mix(a.prototype,{generateSendNumber:function(){return ++this.send_number},getResourcesId:function(){return this.resources_id},verificateReceiveNumber:function(c){if(c>this.receive_number){this.receive_number=c}},reach:function(){if(this.receive_number===this.send_number){return true}return false}});return a});M.define("/js/sales/tool/String",function(a){return{strMask:function(d,b){var c;d=d+"";b=b||"*";c=(d.match(/./g)||[]).length;b=(typeof b=="object")?b:{mask:b};b.mask=b.mask||"*";b.length=(typeof b.length=="number")?Math.min(Math.max(b.length,1),c):Math.min(Math.max(Math.floor(c/2),1),c);b.before=(typeof b.before=="number")?Math.min(b.before,Math.max(c-1,0)):Math.floor((c-b.length)/2);b.after=(typeof b.after=="number")?Math.min(b.after,Math.max($iStrLen-b.before-1,0)):Math.min(Math.ceil((c-b.length)/2),Math.max(c-b.before-1,0));b.length=c-b.before-b.after;maskedStr=d.replace(new RegExp("^(.{"+b.before+"}).*"),"$1")+(new Array(b.length+1)).join(b.mask)+d.replace(new RegExp(".*?(.{"+b.after+"})$"),"$1");return maskedStr}}});M.define("/sales_order/js/pagelet/BookingTool",function(b){var c=b("/js/sales/tool/String"),d=b("/sales_order/js/pagelet/BookingTemplateIntegrity");var a={getNoneFullIds:function(g,h){var e={},f=[];if(g&&g.length){g.forEach($.proxy(function(j){for(var k in h){if(!j.required&&(typeof h[k]==="undefined"||typeof h[k][j.id]==="undefined"||h[k][j.id].length===0)){continue}if(j.group=="composite"){this.checkComposite(k,e,h[k],j.ext,h[k][j.id])}this.checkSingle(k,e,h[k],j)}},this))}for(var i in e){f.push(i)}return f},checkComposite:function(j,e,f,h,i){var g=this.getTempByName(h,i);this.checkSingle(j,e,f,g)},checkSingle:function(h,e,f,g){if(typeof f[g.id]==="undefined"){e[h]=true}else{if(!d.check(g.limit,g.limit_value,f[g.id],g.required)){e[h]=true}}},getTempByName:function(f,e){if(f){for(var g in f){if(g==e){return f[g]}}}return{}},allowAmong:function(j,h,e){var g=false,f=null;for(var i in j){if(e&&e.id==i){f=j[i]}}if(f&&d.check(f.limit,f.limit_value,h[f.id],f.required)){g=true}return g},getPreText:function(i){var f=[],e=(arguments[1]&&arguments[1].length)?arguments[1]:[],h=["identity_id","f1_ext","f2_ext","f11_ext","f12_ext"],g=(arguments[2]&&arguments[2]>0)?arguments[2]:3;if(e.length==0){e.push("f2");e.push("f153");e.push("f154");if(!i.f2&&!i.f153&&!i.f154){if(i.hasOwnProperty("f2")){e.push("last_name");e.push("first_name")}else{if(i.hasOwnProperty("f153")||i.hasOwnProperty("f154")){e.push("passenger_name")}else{e.push("passenger_name")}}}if((i.f4=="身份证")&&i.f1_ext){e.push("f1_ext")}else{if((i.f4=="护照")&&i.f2_ext){e.push("f2_ext")}else{if((i.f4=="港澳通行证")&&i.f11_ext){e.push("f11_ext")}else{if((i.f4=="台湾通行证")&&i.f12_ext){e.push("f12_ext")}else{$.each(h,function(k,j){if(i[j]){e.push(j);return false}})}}}}}e.forEach(function(j){if(f.length>=g){return}if(i.hasOwnProperty(j)&&(i[j]+""!=="")){f.push((h.indexOf(j)!=-1)?c.strMask(i[j]):i[j])}});return(f.length===0)?"未知":f.join(" ")},getUniqueKeyByObj:function(g){var e=[];if(g&&typeof g==="object"){for(var f in g){e.push(f+":"+g[f])}}return e.join(",")},appendCardOnly:function(h,g){var f={f1_ext:1,f2_ext:1,f11_ext:1,f12_ext:1};if(typeof g==="object"){for(var e in g){if(f[e]){this.addCardOnly(h,e,g[e]);if(g.f2){this.addCardOnly(h,"name",g.f2)}}}}},addCardOnly:function(g,e,f){if(typeof f==="string"&&f.length>0){if(!window.Env){window.Env={}}if(!window.Env.card_only){window.Env.card_only={}}if(!window.Env.card_only[g]){window.Env.card_only[g]={}}window.Env.card_only[g][e]=f}},matchCardOnlyStr:function(h,e){if(window.Env&&window.Env.card_only){for(var f in window.Env.card_only){if(f!==h){for(var g in window.Env.card_only[f]){if(e&&e[g]&&e[g]===window.Env.card_only[f][g]){if(window.Env.card_only[f]["name"]){return{id:g,name:window.Env.card_only[f]["name"]}}return{id:g,name:""}}}}}}return{}},matchCardOnly:function(e){if(typeof e==="object"&&typeof e.f10000!=="undefined"){var f=this.matchCardOnlyStr(e.f10000,e);if(f.id==="f1_ext"){if(f.name){return"与【"+f.name+"】的身份证"}return"身份证"}if(f.id==="f2_ext"){if(f.name){return"与【"+f.name+"】的护照"}return"护照"}if(f.id==="f11_ext"){if(f.name){return"与【"+f.name+"】的港澳通行证"}return"港澳通行证"}if(f.id==="f12_ext"){if(f.name){return"与【"+f.name+"】的台湾通行证"}return"台湾通行证"}return""}return""}};return a});M.define("/sales_order/js/pagelet/BookingTravelInfo",function(b){b("jq-tmpl");var a=b("/sales_order/js/pagelet/BookingTpl"),d=b("dialog/alert"),c=b("/sales_order/js/pagelet/BookingConsistency"),e=b("/sales_order/js/pagelet/BookingTool");return{events:{"click,._j_ti_people_atom":"eventChoosePeople","click,._j_ti_expand":"eventExpend"},init:function(){this.initDom();this.initData();this.initTravellerSave();this.initTraveler();this.initStroke();this.initAddress();this.initTake();this.setTplObjs()},initData:function(){if(this.spaceContainer&&this.spaceContainer.length){this.needPeopleNum=this.spaceContainer.data("people_num")}else{this.needPeopleNum=0}this.tplObjs=[];this.tplStrokeObjs=[];this.tplAddressObjs=[];this.tplTakeObjs=[];this.ajaxAbort=null;this.travelerSaveAbort=null;this.travellerSaveSc=null},initTravellerSave:function(){var f=new Date(),g=this.data.tid+":"+f.getTime();this.travellerSaveSc=new c(g)},initDom:function(){this.spaceContainer=this.container.find("._j_ti_people_container");this.travelContainerTmpl=this.container.find("#_j_ti_people_tmpl");this.travelPeopleListTmpl=this.container.find("#_j_ti_people_list_tmpl");this.strokeContainerTmpl=this.container.find("#_j_ti_stroke_tmpl");this.adddressContainerTmpl=this.container.find("#_j_ti_address_tmpl");this.takeContainerTmpl=this.container.find("#_j_ti_take_tmpl")},initTraveler:function(){if(this.container.find("._j_ti_people_container").length>0&&this.needPeopleNum>0){for(var f=1;f<=this.needPeopleNum;f++){this.appendTravelerAtomContainer(f)}}},initStroke:function(){this.appendStrokeAtomContainer()},initAddress:function(){this.appendAddressAtomContainer()},initTake:function(){this.appendTakeAtomContainer()},eventChoosePeople:function(h){var k=$(h.currentTarget),g=k.data("content"),j=k.parents("._j_ti_people_form"),f=k.parents("._j_ti_people_list"),i=j.data("tpl_obj");if(i&&i instanceof a){if(k.hasClass("on")){k.removeClass("on");i.setList({},null,f)}else{j.find("._j_ti_people_atom.on").removeClass("on");k.addClass("on");i.setList(g,k,f)}}},eventExpend:function(f){var g=$(f.currentTarget),h=g.parents(".template-form").find(".user-int");if(g.hasClass("act")){h.slideDown();g.removeClass("act").html("收起<i></i>")}else{h.slideUp();g.addClass("act").html("展开<i></i>")}},appendTakeAtomContainer:function(){var g=this.container.find("._j_ti_take_inner");if(g&&g.length){var f=this.takeContainerTmpl.tmpl();this.appendTakeTemplate(f);g.append(f)}},appendTakeTemplate:function(f){if(f){var g=new a(this.data.template_take,f.find("._j_ti_take_template"));f.data("tpl_obj",g)}},appendAddressAtomContainer:function(){var g=this.container.find("._j_ti_address_inner");if(g&&g.length){var f=this.adddressContainerTmpl.tmpl();this.appendAddressTemplate(f);g.append(f)}},appendAddressTemplate:function(f){if(f){var g=new a(this.data.template_address,f.find("._j_ti_address_template"));var h=this.getDefaultAddress(this.data.address);g.setList(h,null,null);f.data("tpl_obj",g)}},appendStrokeAtomContainer:function(){var g=this.container.find("._j_ti_stroke_inner");if(g&&g.length){var f=this.strokeContainerTmpl.tmpl();this.appendStrokeTemplate(f);g.append(f)}},appendStrokeTemplate:function(f){if(f){var g=new a(this.data.template_stock,f.find("._j_ti_stroke_template"));f.data("tpl_obj",g)}},appendTravelerAtomContainer:function(g){var h=this.container.find("._j_ti_people_inner");if(h&&h.length){var f=this.travelContainerTmpl.tmpl({location:g});this.appendTravelerSelecter(f);this.appendTravelerTemplate(f);h.append(f)}},appendTravelerSelecter:function(h){if(h){var f=h.find("._j_ti_people_list"),k=null,g={},i="";if(this.data&&this.data.traveler&&typeof this.data.traveler==="object"){for(var j in this.data.traveler){g=this.data.traveler[j];this.addTpListAtom(f,j,g,0)}}}},appendTravelerTemplate:function(f){if(f){var g=new a(this.data.template_people,f.find("._j_ti_people_template"));g.setList({},null,f.find("._j_ti_people_list"));g.virtualConfirm($.proxy(function(j,l,k){if(this.ajaxAbort){this.ajaxAbort.abort()}if(l){var i=e.getUniqueKeyByObj(k),h=l.data("unique");if(h!==i){this.ajaxAbort=$.post("/sales/booking_ajax/setTravelInfo",{id:l.data("id"),data:k},$.proxy(function(n){this.editTpListAtom(j,n.data.id,k,1);var m=this.getTpListAtomObjByKey(j,n.data.id);g.setTarget(m)},this),"json")}}else{this.ajaxAbort=$.post("/sales/booking_ajax/setTravelInfo",{id:0,data:k},$.proxy(function(n){this.addTpListAtom(j,n.data.id,k,1);var m=this.getTpListAtomObjByKey(j,n.data.id);g.setTarget(m)},this),"json")}},this));f.data("tpl_obj",g)}},addTpListAtom:function(f,g,j,i){var h=this.getTpListAtomObj(g,j,i);f.append(h)},editTpListAtom:function(f,h,j,i){var k=this.getTpListAtomObjByKey(f,h);if(k){var g=this.getTpListAtomObj(h,j,i);k.replaceWith(g)}},getTpListAtomObjByKey:function(f,g){var h=null;f.find("._j_ti_people_atom").each($.proxy(function(j,l){var k=$(l);if(k.data("id")==g){h=k}},this));return h},getTpListAtomObj:function(h,k,j){var g=e.getPreText(k,["f2","f154","f153"],3),i=this.travelPeopleListTmpl.tmpl({name:g,is_choose:j}),f=e.getUniqueKeyByObj(k);i.data("content",k).data("id",h).data("unique",f);return i},setTplObjs:function(){this.tplObjs=this.getTplObjs("people");this.tplStrokeObjs=this.getTplObjs("stroke");this.tplAddressObjs=this.getTplObjs("address");this.tplTakeObjs=this.getTplObjs("take")},getTplObjs:function(f){var g=[],h=this.container.find("._j_ti_"+f+"_form");if(h&&h.length){h.each($.proxy(function(k,j){var m=$(j),l=m.data("tpl_obj");if(l&&l instanceof a){g.push(l)}},this))}return g},getDefaultAddress:function(g){if(g){for(var h in g){if(g[h]&&g[h].is_default&&g[h].content){var f=g[h].content;if(f&&f.take_name&&f.take_phone&&f.take_pre){return{take_name:f.take_name,take_phone:f.take_phone,take_address:f.take_pre}}}}}return{}},checkTplAllow:function(g){var f=true;if(g&&g.length){g.forEach(function(h){if(!h.checkInputList()){f=false}})}return f},gotoWarning:function(){this.container.find("._j_template_error.show").each(function(g,f){var j=$(f),h=j.offset().top;$("body,html").animate({scrollTop:(h-30)+"px"},{duration:500,easing:"swing"});return false})},filterTakeStruct:function(g){var f={};if(g&&g.take){f.f301=g.take}if(g&&g.still){f.f302=g.still}return f},filterAddressStruct:function(g){var f={};if(g&&g.take_name){f.f501=g.take_name}if(g&&g.take_phone){f.f502=g.take_phone}if(g&&g.take_address){f.f101=g.take_address}return f},getSaveData:function(){var f={take:{},address:{},stroke:{},people:[]};if(this.tplObjs&&this.tplObjs.length){this.tplObjs.forEach(function(g){f.people.push(g.getData())})}if(this.tplStrokeObjs&&this.tplStrokeObjs.length){if(this.tplStrokeObjs[0] instanceof a){f.stroke=this.tplStrokeObjs[0].getData()}}if(this.tplAddressObjs&&this.tplAddressObjs.length){if(this.tplAddressObjs[0] instanceof a){f.address=this.tplAddressObjs[0].getData()}}if(this.tplTakeObjs&&this.tplTakeObjs.length){if(this.tplTakeObjs[0] instanceof a){f.take=this.tplTakeObjs[0].getData()}}return f},saveTravel:function(){var i=this.getSaveData(),f={},h=true;if(this.data&&this.data.show_items&&i){if(this.data.show_items.people&&i.people){f.people={data:i.people}}if(this.data.show_items.stroke&&i.stroke){f.stroke={data:i.stroke}}if(this.data.show_items.take&&i.take){f.take={data:this.filterTakeStruct(i.take)}}if(this.data.show_items.address&&i.address){f.address={data:this.filterAddressStruct(i.address)}}if(this.travelerSaveAbort){this.travelerSaveAbort.abort()}var g=this.unityData();this.travelerSaveAbort=$.ajax({type:"post",url:"/sales/order/rest/temporary/",async:false,data:{post_style:"update",after_style:"update",update:{tid:this.data.tid,resources_id:this.travellerSaveSc.getResourcesId(),request_number:this.travellerSaveSc.generateSendNumber(),content:f,complete:g.complete,people_num:g.people_num}},success:$.proxy(function(j){if(j&&j.data&&j.data.after&&j.data.after.ret&&j.data.after.request_number){this.travellerSaveSc.verificateReceiveNumber(j.data.after.request_number)}else{h=false}},this)})}return h},unityCheckIntegrity:function(){var f=true;if(!this.travellerSaveSc.reach()){d.warning("出行信息同步失败，是否重试？",$.proxy(function(){this.saveTravel()},this),$.proxy(function(){},this));f=false}if(!this.checkTplAllow(this.tplObjs)||!this.checkTplAllow(this.tplStrokeObjs)||!this.checkTplAllow(this.tplAddressObjs)||!this.checkTplAllow(this.tplTakeObjs)){f=false}if(!f){this.gotoWarning()}else{f=this.saveTravel()}return f},unityData:function(){var f={complete:1,tid:this.data.tid,people_num:this.needPeopleNum};return f}}});M.define("/sales_order/js/pagelet/ExtraCharge",function(a){a("jq-tmpl");return{events:{"click,._j_extra_change":"eventChangePrice","click,._j_additional_model":"eventClickAdditional"},init:function(){this.initData()},initData:function(){this.additionalFee={totalPrice:0,list:{}}},eventInitClick:function(){$("._j_additional_atom").each(function(){var b=$(this);b.find("._j_additional_model:eq(0)").trigger("click")})},eventChangePrice:function(b){var c=$(b.currentTarget);if(!c.hasClass("on")&&!c.hasClass("disabled")){c.addClass("on").siblings().removeClass("on")}},eventClickAdditional:function(g){var h=$(g.currentTarget),e=h.parents(".form-box").data("key"),d=h.parents(".form-box").data("num"),f=parseFloat(h.data("price")),c=h.context.dataset.name,i=h.data("id"),b={id:i,num:d};if(window.isNaN(f)){f=0}this.getAdditionalInfo(b,f*d,c,"additional",e+"")},getAdditionalInfo:function(g,e,b,d,c){e=this.round(e);if(!this.additionalFee.list[c]){this.additionalFee.list[c]={price:0,name:"",data:{},key:""}}var f=this.additionalFee.list[c].price;var h=this.additionalFee.totalPrice;if(e!=f||(e==0&&f==0)){this.additionalFee.totalPrice=h-f+e;this.additionalFee.list[c].price=e;this.additionalFee.list[c].name=b;this.additionalFee.list[c].data=g;this.additionalFee.list[c].key=d;this.additionalFee.list[c].sub_key=c}var j=[];for(var i in this.additionalFee.list){j.push(this.additionalFee.list[i])}M.Event.fire("order:price:change",{name:"additional",price:this.additionalFee.totalPrice,data:j,list:[{name:"附加费",price:this.additionalFee.totalPrice}]})},unityCheckIntegrity:function(){return true},round:function(b){return Math.round(b*100)/100},}});M.define("/sales_order/js/pagelet/BookingTyingV2",function(c){var a=$("._j_ty_sku_list"),b=$("._j_ty_container"),e=$("._j_ty_people_tpl"),d=c("dialog/alert"),g=c("/sales_order/js/pagelet/BookingTool"),f=c("/js/sales/tool/StringCheck");return{events:{"click,._j_ty_expand_desc":"expandDesc","click,._j_ty_hide_desc":"hideDesc","click,._j_ty_desc_tab":"switchTab","click,._j_ty_sku_list span":"switchSku","click,._j_ty_people_choose":"choosePeople","click,._j_ty_add_people":"addPeople","click,._j_ty_choose_product":"chooseProduct","click,._j_ty_delete_people":"deletePeople","input propertychange,._j_ty_input":"changeInput","blur,._j_ty_input":"blurInput","focus,._j_ty_input":"focusInput","click,._j_ty_label":"focusInputFromLabel"},init:function(){this.initDate();this.initSpecial();this.initData()},initData:function(){this.peopleAtomListTmpl=$("#_j_ty_people_atom_tmpl")},initSpecial:function(){this.container.find("._j_ty_pd").each($.proxy(function(j,l){var m=$(l),k=m.data("special");if(!k){m.find("._j_ty_specail").show()}else{m.find("._j_ty_people_choose").remove();if(!m.find(".peo-safe").length){m.find("._j_ty_specail").prepend('<div class="clearfix ins-form"><p>选择被保人</p><div class="peo-safe"> </div></div>')}var h=this.data.people_num;for(var j=0;j<h;j++){this.getItemHtml(m,{index:j,identity_id:"110101198001018290",passenger_name:"XXXX_DEFAULT"})}m.find("._j_ty_people_choose").trigger("click")}if(this.data&&this.data.default_choose){m.find("._j_ty_choose_product").trigger("click")}},this))},getItemHtml:function(j,h){var i='<span class="_j_ty_people_choose" data-index="${index}" data-identity_id="${identity_id}" data-passenger_name="${passenger_name}"><em></em>${passenger_name}</span>';j.find(".peo-safe").append($.tmpl(i,h))},changeInput:function(h){this.onChangePrice()},expandDesc:function(i){var k=$(i.currentTarget),j=k.parents(".tit"),h=j.siblings(".rules");if(h.hasClass("current")){h.slideUp();h.removeClass("current")}else{h.slideDown();h.addClass("current")}},bIdentityCodeValid:function(p){if(typeof p!=="string"){return false}p=p.toUpperCase();var l={11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",21:"辽宁",22:"吉林",23:"黑龙江 ",31:"上海",32:"江苏",33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",42:"湖北 ",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",51:"四川",52:"贵州",53:"云南",54:"西藏 ",61:"陕西",62:"甘肃",63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外"};var s=p.substr(6,4)+"/"+Number(p.substr(10,2))+"/"+Number(p.substr(12,2));var o=new Date(s);var t=o.getFullYear()+"/"+Number(o.getMonth()+1)+"/"+Number(o.getDate());var j=new Date().getTime();var k=o.getTime();var q=[7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2];var r=["1","0","X","9","8","7","6","5","4","3","2"];var n=0,m,h;if(!/^\d{17}(\d|x)$/i.test(p)){return false}if(l[p.substr(0,2)]===undefined){return false}if(k>=j||s!==t){return false}for(m=0;m<17;m++){n+=p.substr(m,1)*q[m]}h=r[n%11];if(h!==p.substr(17,1)){return false}return true},daysBetween:function(h,l){var k=Date.parse(new Date(h));var j=Date.parse(new Date(l));var i=Math.abs(parseInt((j-k)/1000/3600/24))+1;return i},hideDesc:function(i){var j=$(i.currentTarget),h=j.parents(".rules");if(h.hasClass("current")){h.slideUp();h.removeClass("current")}},switchTab:function(i){var k=$(i.currentTarget),j=k.parents(".tab-tle"),h=k.data("sku-id");if(!k.hasClass("on")){k.siblings("._j_ty_desc_tab").removeClass("on");k.addClass("on");j.siblings(".rules-cent").hide();j.siblings(".rules-cent[data-sku-id='"+h+"']").show()}},switchSku:function(h){var j=$(h.currentTarget),i=j.parents("._j_ty_pd");if(!j.hasClass("check")){j.siblings("span").removeClass("check");j.addClass("check");this.changePrice(i)}},choosePeople:function(q){var n=$(q.currentTarget),l=n.data("index"),r=n.data("identity_id"),p=n.data("passenger_name"),i=n.parents("._j_ty_pd"),j=n.parents(".peo-safe"),h=i.find("._j_ty_people_container"),k=i.find("._j_ty_num"),s=i.find("._j_ty_tips"),o=i.data("type"),m=i.find("._j_ty_people_choose.on").length;if(n.hasClass("on")){var t=h.find("._j_ty_people_list[data-index="+l+"]");this.changePeopleData(t,-1,"","","");if(t){t.data("target",null).data("listTarget",j)}n.removeClass("on")}else{if((o==4)&&(m>=this.data.people_num)){d.pop("最多可选择"+this.data.people_num+"人 ")}else{var t=this.insertPeopleItem(h,l,p,r,"focus");if(t){t.data("target",n).data("listTarget",j)}n.addClass("on")}}m=i.find("._j_ty_people_choose.on").length;k.text(m?("×"+m):"");s.length&&s.css("display",m?"":"none").find(".num").text(m);this.changePeopleList();this.onChangePrice()},focusInput:function(h){var j=$(h.currentTarget),i=j.parents(".form-sec");this.focusInputOrg(i)},focusInputFromLabel:function(h){var j=$(h.currentTarget),i=j.parents(".form-sec");this.focusInputOrg(i);i.find("._j_ty_input").focus()},focusInputOrg:function(h){h.removeClass("form-sec-active").addClass("form-sec-focus")},blurInput:function(k){var m=$(k.currentTarget),o=m.val(),h=m.parents("._j_ty_people_list"),j=h.data("target"),i=h.data("listTarget"),n=this.getPeopleData(h),l={passenger_name:n.name,identity_id:n.identity_id};if(o.length===0){m.parents(".form-sec").removeClass("form-sec-focus")}if(!i){i=m.parents("._j_ty_pd").find(".peo-safe");h.data("listTarget",i)}if(n&&n.name&&n.name.length&&n.identity_id&&n.identity_id.length){if(this.bIdentityCodeValid(n.identity_id)){if(j){$.post("/sales/booking_ajax/setTravelInfo",{id:j.data("id"),data:l},$.proxy(function(q){this.editTpListAtom(i,q.data.id,l,1);var p=this.getTpListAtomObjByKey(i,q.data.id);h.data("target",p)},this),"json")}else{$.post("/sales/booking_ajax/setTravelInfo",{id:0,data:l},$.proxy(function(s){this.addTpListAtom(i,s.data.id,l,1);var q=this.getTpListAtomObjByKey(i,s.data.id);h.data("target",q);h.data("index",s.data.id).attr("data-index",s.data.id);var v=m.parents("._j_ty_pd"),u=v.find("._j_ty_num"),t=v.find("._j_ty_tips"),p=v.find("._j_ty_people_choose.on").length;u.text(p?("×"+p):"");t.length&&t.css("display",p?"":"none").find(".num").text(p)},this),"json")}}}},addTpListAtom:function(h,i,l,k){var j=this.getTpListAtomObj(i,l,k);h.append(j)},editTpListAtom:function(h,j,l,k){var m=this.getTpListAtomObjByKey(h,j);if(m){var i=this.getTpListAtomObj(j,l,k);m.replaceWith(i)}},getTpListAtomObj:function(i,m,l){var j={id:i,identity_id:m.identity_id,passenger_name:m.passenger_name,is_choose:l},h=g.getUniqueKeyByObj(j),k=this.peopleAtomListTmpl.tmpl(j);k.data("unique",h);return k},getTpListAtomObjByKey:function(h,i){var j=null;h.find("._j_ty_people_choose").each($.proxy(function(k,m){var l=$(m);if(l.data("id")==i){j=l}},this));return j},addPeople:function(i){var k=$(i.currentTarget),j=k.parents("._j_ty_pd"),h=j.find("._j_ty_people_container");this.insertPeopleItem(h,-1,"","","active");this.changePeopleList();this.onChangePrice()},chooseProduct:function(j){var k=$(j.currentTarget),h=k.parents("._j_ty_pd"),i=h.find(".ins-cont");if(k.hasClass("check")){k.removeClass("check");i.slideUp();h.find("._j_ty_tips").addClass("hide")}else{k.addClass("check");i.slideDown();h.find("._j_ty_tips").removeClass("hide")}this.onChangePrice()},deletePeople:function(o){var m=$(o.currentTarget),h=m.parents("._j_ty_people_list"),k=h.attr("data-index");if(k!=-1){var n=$("._j_ty_people_choose[data-index='"+k+"']");if(n.hasClass("on")){n.removeClass("on")}var i=m.parents("._j_ty_pd"),j=i.find("._j_ty_num"),p=i.find("._j_ty_tips"),l=i.find("._j_ty_people_choose.on").length;j.text(l?("×"+l):"");p.length&&p.css("display",l?"":"none").find(".num").text(l)}h.remove();this.changePeopleList();this.onChangePrice()},initDate:function(){this.totalPrice=0;$("._j_ty_begin_date").datetimepicker({timepicker:false,lang:"zh",format:"Y-m-d",formatDate:"Y-m-d",todayButton:false,scrollMonth:false,scrollInput:false,showApplyButton:false,initTime:false,defaultSelect:false,theme:"mfw",yearStart:1900,yearEnd:2050,onChangeDateTime:$.proxy(function(k,p){var h=$(p[0]),m=h.parents("._j_ty_pd"),j=new Date(k),n=j.getFullYear()+"-",o=(j.getMonth()+1<10?"0"+(j.getMonth()+1):j.getMonth()+1)+"-",l=j.getDate()<10?"0"+j.getDate():j.getDate();h.find("p").text(n+o+l);if(p.length){this.changeDate(m)}},this)});$("._j_ty_end_date").datetimepicker({timepicker:false,lang:"zh",format:"Y-m-d",formatDate:"Y-m-d",todayButton:false,scrollMonth:false,scrollInput:false,showApplyButton:false,initTime:false,defaultSelect:false,theme:"mfw",yearStart:1900,yearEnd:2050,onChangeDateTime:$.proxy(function(k,p){var h=$(p[0]),m=h.parents("._j_ty_pd"),j=new Date(k),n=j.getFullYear()+"-",o=(j.getMonth()+1<10?"0"+(j.getMonth()+1):j.getMonth()+1)+"-",l=j.getDate()<10?"0"+j.getDate():j.getDate();h.find("p").text(n+o+l);if(p.length){this.changeDate(m)}},this)})},checkDateIntegrity:function(h,i){if(f.iDateContrast(i,h)===-1){return false}return true},insertPeopleItem:function(i,l,k,j,h){var m=this.insertPeopleDom(i,l);this.changePeopleData(m,l,k,j,h);return m},getPeopleDomName:function(){return{name:".form-sec[data-key='name'] input",identity_id:".form-sec[data-key='identity_id'] input"}},changePeopleData:function(l,k,j,i,h){if(l&&l.length){l.attr("data-index",k);var m=this.getPeopleDomName();l.find(m.name).val(j);l.find(m.identity_id).val(i);if(h=="focus"){l.find(".form-sec").addClass("form-sec-focus")}else{if(h=="active"){l.find(".form-sec").addClass("form-sec-active")}else{l.find(".form-sec").removeClass("form-sec-active").removeClass("form-sec-focus")}}}},getPeopleData:function(j){var k=this.getPeopleDomName(),i=j.find(k.name).val(),h=j.find(k.identity_id).val();h=this.filterN(h);return{name:i,identity_id:h}},isEmptyPeopleData:function(h){var i=this.getPeopleData(h);if(i.name.length>0||i.name.identity_id){return false}return true},getCanCoverItem:function(h){var i=null;h.find("._j_ty_people_list").each($.proxy(function(l,k){var n=$(k),j=n.attr("data-index");if(j==-1){var m=true;if(!this.isEmptyPeopleData(n)){m=false}if(m&&!i){i=n;return false}}},this));return i},insertPeopleDom:function(h,i){if(i===-1){return this.insertItem(h)}else{var j=this.getCanCoverItem(h);if(!j){return this.insertItem(h)}else{return j}}},insertItem:function(h){var i=e.html();h.append(i);return h.find("._j_ty_people_list").last()},getChSuk:function(){var h=a.find(".check");if(h.length){return h.data("sku_id")}return 0},changePrice:function(h){var j=h.find("._j_ty_sku_list .check").data("sku-id"),l=h.find("._j_ty_begin_date p").text(),o=h.find("._j_ty_end_date p").text(),n=h.find("._j_ty_sku_list .check").data("mdd-id"),i=h.find("._j_ty_sku_list .check").data("basic-price");if(l.length>0&&o.length>0){var m=this.daysBetween(l,o);var k={filter:{type:"getins",sales_id:j,attr_id:m,mdd_id:n,basic_price:i},data_style:"html"};$.get("/rest/sales/stock/",k,$.proxy(function(q){if(q&&q.data&&q.data.list){var p=q.data.list[j];if(p&&p>0){h.find("._j_ty_price").text(p);h.find("._j_ty_unit").text(" /份");this.onChangePrice()}else{d.pop("选择天数超出最大保险天数！")}}else{d.pop("保险不存在，请刷新页面后重试！")}},this),"json")}},changeAllPrice:function(){this.container.find("._j_ty_pd").each($.proxy(function(h,j){var k=$(j);this.changePrice(k)},this))},getInsuranceData:function(){var h={data:[],msg:""};b.find("._j_ty_pd").each($.proxy(function(n,v){var u=$(v),k=this.getPeopleDomName();if(u.find("._j_ty_pd_min .check").length>0){var m=u.find("._j_ty_sku_list .check").data("sku-id"),l=u.find("._j_ty_begin_date p").text(),j=u.find("._j_ty_end_date p").text(),q=u.find("._j_ty_sku_list .check").data("max-day"),r=0,p=true;var t=this.daysBetween(l,j);if(m<=0){h.msg="保险不存在，请刷新页面后重试！";return false}var o=new Date(Date.parse(l.replace(/-/g,"/")));var s=this.getNowFormatDate();if(o<s){h.msg="保险开始时间不能小于当日！";u.find("._j_ty_begin_date").parents(".ins-form").addClass("ina-active");return false}if(l.length===0){h.msg="保险开始日期不能为空！";u.find("._j_ty_begin_date").parents(".ins-form").addClass("ina-active");return false}if(j.length===0){h.msg="保险结束日期不能为空！";u.find("._j_ty_begin_date").parents(".ins-form").addClass("ina-active");return false}if(!this.checkDateIntegrity(j,l)){h.msg="保险结束日期不能小于开始日期！";u.find("._j_ty_begin_date").parents(".ins-form").addClass("ina-active");return false}if(t>q){h.msg="选择天数超出最大保险天数(最多"+q+"天)！";u.find("._j_ty_begin_date").parents(".ins-form").addClass("ina-active");return false}u.find("._j_ty_people_container ._j_ty_people_list").each($.proxy(function(w,i){var x=$(i),y=this.getPeopleData(x);if(y.name.length||y.identity_id.length){if(y.name.length===0){h.msg="姓名不能为空";this.vErrorAction(u,x,k.name);p=false;return false}if(y.identity_id.length===0){h.msg="身份证不能为空";this.vErrorAction(u,x,k.identity_id);p=false;return false}if(!this.bIdentityCodeValid(y.identity_id)){h.msg="保险仅支持大陆身份证！";this.vErrorAction(u,x,k.identity_id);p=false;return false}y.sku_id=m;y.begin_date=l;y.end_date=j;h.data.push(y);r++}},this));if(p&&r===0){h.msg="请选择被保人";return false}}},this));return h},filterN:function(h){if(h&&h.length>0){return h.replace(/^\s+|\s+$/gm,"")}return""},vErrorAction:function(i,j,h){j.find(h).focus()},getBaseInfo:function(){return{name:$.trim($("#base_name").val()||""),phone:$.trim($("#base_phone").val()||""),email:$.trim($("#base_email").val()||""),wechat:$.trim($("#base_wechat").val()||"")}},getCompatiblePrice:function(){var h=0;b.find("._j_ty_pd").each($.proxy(function(l,m){var k=$(m),n=k.find("._j_ty_begin_date p").text(),o=k.find("._j_ty_end_date p").text();if(n.length>0&&o.length>0&&k.find("._j_ty_pd_min .check").length>0){var j=parseFloat(k.find("._j_ty_price").text());k.find("._j_ty_people_container ._j_ty_people_list").each($.proxy(function(p,i){var q=$(i),r=this.getPeopleData(q);if(r.name.length||r.identity_id.length){h+=j}},this))}},this));return h},changePeopleList:function(){this.container.find("._j_ty_pd").each($.proxy(function(h,i){var k=$(i);k.find("._j_ty_people_list").each($.proxy(function(m,l){var j=$(l);j.find("em").text(m+1)},this))},this))},changeDate:function(l){var k=l.find("._j_ty_begin_date p").text(),n=l.find("._j_ty_end_date p").text(),j=l.find("._j_ty_sku_list .check").data("max-day");if(k.length>0&&n.length>0){if(this.checkDateIntegrity(n,k)){var m=this.daysBetween(k,n);this.container.find("._j_ty_days em").each($.proxy(function(o,p){var q=$(p);q.text(m)},this));var i=new Date(Date.parse(k.replace(/-/g,"/")));var h=this.getNowFormatDate();if(i<h){l.find("._j_ty_begin_date").parents(".ins-form").addClass("ina-active");d.pop("开始时间不能小于当日！")}l.find("._j_ty_begin_date").parents(".ins-form").removeClass("ina-active");if(m>j){l.find("._j_ty_begin_date").parents(".ins-form").addClass("ina-active");d.pop("选择天数超出最大保险天数(最多"+j+"天)！")}else{this.changeAllPrice()}}else{l.find("._j_ty_begin_date").parents(".ins-form").addClass("ina-active");d.pop("结束日期不能小于开始日期！")}}},getNowFormatDate:function(){var i=new Date();var h="-";var l=i.getMonth()+1;var k=i.getDate();if(l>=1&&l<=9){l="0"+l}if(k>=0&&k<=9){k="0"+k}var j=i.getFullYear()+h+l+h+k;var m=new Date(Date.parse(j.replace(/-/g,"/")));return m},onChangePrice:function(){var h=this.getCompatiblePrice();if(this.totalPrice!==h){M.Event.fire("order:price:change",{name:"tying",price:h,list:[{price:h,name:"保险"}]});this.totalPrice=h}},unityCheckIntegrity:function(){var h=this.getInsuranceData();if(h.msg.length===0){return true}else{alert(h.msg);return false}},unityData:function(){var h=[],i=this.getInsuranceData();if(i.msg.length===0){if(i.data.length){h.push({begin_date:i.data[0].begin_date,end_date:i.data[0].end_date,stock_id:i.data[0].sku_id,peoples:i.data})}}return h}}});M.define("/sales_order/js/pagelet/BookedBy",function(b){b("jq-tmpl");var a=b("/js/sales/tool/CodeCheck"),e=b("/js/sales/tool/StringFilter"),c=b("dialog/alert"),d=b("/js/sales/tool/StringCheck");return{events:{"blur,._j_booked_check":"eventChangeInput","click,.form-sec":"eventFocusInput","blur,.form-sec":"eventBlurInput","blur,#base_phone":"eventCheckPhone","click,.notFail":"eventClickInput","click,._j_send_sms":"eventSendSms",},init:function(){this.initDom();this.initSuggest()},initSuggest:function(){$("[data-E]").mailAutoComplete({boxClass:"parentCls",autoClass:false,textHint:false,hintText:"请输入邮箱地址",focusColor:"",blurColor:""})},initDom:function(){this.baseNameInput=this.container.find("#base_name");this.basePhoneInput=this.container.find("#base_phone");this.baseEmailInput=this.container.find("#base_email");this.baseWeChatInput=this.container.find("#base_wechat");this.baseDescriptionInput=this.container.find("#base_description");this.baseValidCode=this.container.find("#valid_code");this.baseValidSms=this.container.find(".valid-sms");this.baseSendSms=this.container.find("._j_send_sms")},eventCheckPhone:function(g){var i=e.sFilterN(g.currentTarget.value),h=this.data.old_phone,f=this.data.is_demotion;if(!f&&((i!=h)&&i)){this.baseValidSms.show();this.baseValidCode.val("")}else{this.baseValidSms.hide()}},eventFocusInput:function(f){var g=$(f.currentTarget);g.addClass("form-sec-active")},eventBlurInput:function(f){var g=$(f.currentTarget);g.removeClass("form-sec-active")},eventClickInput:function(f){var h=$(f.currentTarget),g=h.parents(".form-sec");g.addClass("form-sec-focus form-sec-active");h.siblings("input").focus();h.remove()},eventChangeInput:function(f){var h=$(f.currentTarget),i=e.sFilterN(f.currentTarget.value),g=this.data.old_phone;b=f.currentTarget.required;if((!i.length&&g)&&b){this.showWarning(f)}else{h.nextAll(".notFail").remove()}},eventSendSms:function(g){var j=$(g.currentTarget),f=this.basePhoneInput,l=f.val(),i=60,k=j.data("times"),h={update:{},};if(l.charAt(0)=="+"){if(l.charAt(1)=="0"&&l.charAt(2)=="0"){f.val(l.replace("+",""))}else{f.val(l.replace("+","00"))}}if(j.data("lock")){return}if(!a.bTelVaild(f.val())){c.warning("手机号格式错误");return}j.data("lock",true);h.update.phone=$.trim(f.val());h.post_style="default";h.after_style="default";$.post("/rest/localdeals/order/sendMobileCode/",h,$.proxy(function(m){if(m.errno){c.warning(m.error);if(k<=2){j.data("lock",false);j.html("发送验证码");k=k+1;j.data("times",k)}else{this.countDown(i)}}else{this.countDown(i);if(m.data&&m.data.pure&&m.data.pure.phone){this.basePhoneInput.val(m.data.after.phone)}}},this),"json")},countDown:function(g){var f=this.baseSendSms;if(g=="undefined"){g=60}f.html(g+"秒重发");g=g-1;if(g>=0){setTimeout($.proxy(function(){this.countDown(g)},this),1000)}else{f.data("lock",false);f.html("发送验证码")}},showWarning:function(g){var i=$(g.currentTarget),h=i.parents(".form-sec"),j=g.currentTarget.title;h.removeClass("form-sec-focus");if(!i.nextAll(".notFail").show().length){var f='<label class="notFail';f+='" for="'+i.attr("id")+'"><i></i>请填写正确的'+j+"</label>";i.after($(f))}},showSubmitWarning:function(i,j){var h=i,g=h.parents(".form-sec");g.removeClass("form-sec-focus");if(!h.nextAll(".notFail").show().length){var f='<label class="notFail';f+='" for="'+h.attr("id")+'"><i></i>'+j+"</label>";h.after($(f))}},getData:function(){return{name:this.baseNameInput.val()||"",phone:e.sFilterN(this.basePhoneInput.val())||"",email:e.sFilterN(this.baseEmailInput.val())||"",wechat:e.sFilterN(this.baseWeChatInput.val())||"",description:this.baseDescriptionInput.val()||"",sms_code:this.baseValidCode.val()||""}},unityCheckIntegrity:function(){var g=this.getData(),h=this.data.old_phone,f=this.data.is_demotion;if(g){var i="";if(this.baseNameInput.val()===0||!d.bChineseNameVaild(g.name)){i="请输入正确的中文姓名";this.showSubmitWarning(this.baseNameInput,i);return false}else{if(g.phone.length===0){i="请填写手机号码";this.showSubmitWarning(this.basePhoneInput,i);return false}else{if(!a.bTelVaild(g.phone)){i="请填写正确的数字";this.showSubmitWarning(this.basePhoneInput,i);return false}else{if(g.phone.length<3||g.phone.length>20){i="请填写3~20位以内的数字";this.showSubmitWarning(this.basePhoneInput,i);return false}else{if(this.baseEmailInput.length&&!a.bEmailVaild(g.email)){i="邮箱格式错误";this.showSubmitWarning(this.baseEmailInput,i);return false}else{if(g.email.length>50){i="最长50个字符";this.showSubmitWarning(this.baseEmailInput,i);return false}else{if(this.baseWeChatInput.length&&!a.bWeixinVaild(g.wechat)){i="请输入正确的微信号";this.showSubmitWarning(this.baseWeChatInput,i);return false}else{if(this.baseDescriptionInput.length&&g.description.length>200){i="备注最多200字";this.showSubmitWarning(this.baseDescriptionInput,i);return false}else{if(!f&&g.phone!=h&&!g.sms_code){i="请输入验证码";this.showSubmitWarning(this.baseValidCode,i);return false}}}}}}}}}if(i.length>0){return false}return true}return true},unityData:function(){var f=this.getData();return f}}});M.define("/js/module/app/Page",function(b,a,d){function c(e){M.mix(this,e);this.container=$(this.container);if(!this.container.length){this.container=$(document)}this.init();if(!M.isEmptyObject(this.events)){this.setEvents(this.events)}this.bindEvents()}M.mix(c.prototype,{container:null,events:[],init:$.noop,bindEvents:$.noop,setEvents:function(e){M.forEach(e,$.proxy(function(i,g){var j=g.split(","),h=$.trim(j[0]),f=j.slice(1);if(i in this.eventHandlers){if(f.length){f=$.trim(f.join(","));this.container.on(h,f,$.proxy(this.eventHandlers[i],this))}else{this.container.on(h,$.proxy(this.eventHandlers[i],this))}}},this))},destroy:$.noop,eventHandlers:{}});d.exports=c});M.define("dialog/confirm",function(c,e){var g=c("dialog/Dialog"),a='<div id="popup_container" class="popup-box new-popbox"><a class="close-btn _j_close _j_false"><i></i></a><div class="pop-ico" id="popup_icon"><i class="i2"></i></div><div class="pop-ctn"><p class="hd _j_content"></p><p class="bd _j_detail"></p></div><div class="pop-btns"><a role="button" tabindex="0" class="popbtn popbtn-cancel popbtn-half _j_close _j_false">&nbsp;取消&nbsp;</a><a role="button" tabindex="0" class="popbtn popbtn-submit popbtn-half _j_close _j_true">&nbsp;确定&nbsp;</a></div></div>',h=M.extend(function(k){var j={width:420,content:"请输入内容",background:"#000",bgOpacity:0.7,PANEL_CLASS:"pop_no_margin",reposition:true,impl:"Confirm",layerZIndex:10000};k=M.mix(j,k);h.$parent.call(this,k);this.bindEvents()},g),d=null,b=$.noop,i=$.noop,f=false;M.mix(h.prototype,{tpl:a,setConfirmTitle:function(j){this.setContent(j)},setConfirmContent:function(j){this.getPanel().find("._j_detail").text(j)},setAssureWords:function(j){this.getPanel().find(".popbtn-submit").text(j)},setCancelWords:function(j){this.getPanel().find(".popbtn-cancel").text(j)},bindEvents:function(){this.getPanel().on("click","._j_false",function(){f=false}).on("click","._j_true",function(){f=true}).on("keydown","._j_false",function(j){if(j.keyCode==13){$(this).trigger("click")}else{if(j.keyCode==39){$(this).next().focus()}}}).on("keydown","._j_true",function(j){if(j.keyCode==13){$(this).trigger("click")}else{if(j.keyCode==37){$(this).prev().focus()}}})}});e.pop=function(k,j,l){if(!d){d=new h();M.Event(d).on("afterhide",function(){if(f){b()}else{i()}});M.Event(d).on("aftershow",function(){d.getPanel().find("._j_true").focus()})}d.getLayer().toFront();if(M.isObject(k)){d.setConfirmTitle(k.title);d.setConfirmContent(k.content)}else{d.setConfirmTitle(k);d.setConfirmContent("")}if(M.isObject(k)){if(k.assureWords){d.setAssureWords(k.assureWords)}else{d.setAssureWords("确定")}if(k.cancelWords){d.setCancelWords(k.cancelWords)}else{d.setCancelWords("取消")}}else{d.setAssureWords("确定");d.setCancelWords("取消")}if(typeof j=="function"){b=j}else{b=$.noop}if(typeof l=="function"){i=l}else{i=$.noop}d.show();return d}});M.define("dialog/BindMobileAlert",function(b,a){var c=b("dialog/alert");return{pop:function(d,e){!!mfwPageEvent&&mfwPageEvent("ugc","needbindmobile",{act:"show"});return c.pop(d,e)}}});M.define("/promotion/js/v2/japp/PromotionModel",function(a){var b=function(){this.init()};M.mix(b.prototype,{init:function(){this.initData()},initData:function(){this.busiType="";this.productId=0;this.basePrice=0;this.promotionParams={};this.promotionResult=[];this.promotionCallbacks={};this.calculateXhr=null;this.autoSelectIsWaiting=false;this.autoSelectParams=[]},setBusiType:function(c){this.busiType=c;return this},setProductId:function(c){this.productId=c;return this},setBasePrice:function(c){if((this.basePrice||0)==c){return this}this.basePrice=c;this.loadResult();return this},setPromotionParam:function(d,e){var f={},c=false;if($.isPlainObject(d)){f=d}else{f[d]=e}$.each(f,$.proxy(function(g,h){if((this.promotionParams[g]||"")!=(h||"")){this.promotionParams[g]=h;c=true}},this));c&&this.loadResult();return this},getPromotionParam:function(c){return this.promotionParams[c]},getPromotionResult:function(c){return c?(this.promotionResult.filter(function(d){return d.discount_type==c})[0]||undefined):this.promotionResult},setPromotionCallback:function(c,d){this.promotionCallbacks[c]=d;return this},loadResult:function(){this.calculateXhr&&this.calculateXhr.abort();this.calculateXhr=$.post("/promotions/calculate",{busi_type:this.busiType,product_id:this.productId,base_price:this.basePrice,promotion_params:this.promotionParams},$.proxy(function(c){this.promotionResult=c.data;$.each(this.promotionResult,$.proxy(function(d,e){this.promotionParams[e.discount_type]=e.code;this.promotionCallbacks[e.discount_type]&&this.promotionCallbacks[e.discount_type](e)},this));M.Event.fire("coupon:center:price:change",{base_price:this.basePrice,list:this.promotionResult});if(this.autoSelectIsWaiting){this.autoSelectIsWaiting=false;this.autoSelect.apply(this,this.autoSelectParams);this.autoSelectParams=[]}},this))},autoSelect:function(g,h){var f=["OtaCoupon","MfwCoupon","Honey","Vip"],j={},e={},d=$.proxy(function(k,l){var m=0;j[k]=l;e[k]=true;$.each(e,function(o,p){!p&&m++});(m==0)&&this.setPromotionParam(j)},this);if(!g||!g.length){return}if(!this.promotionResult||(this.promotionResult.length==0)){this.autoSelectIsWaiting=true;this.autoSelectParams=arguments;return}$.each(g,function(k,l){if(f.indexOf(l)!=-1){e[l]=false}});if(g.indexOf("OtaCoupon")!=-1||g.indexOf("MfwCoupon")!=-1){$.get("/promotions/coupon/auto",{busi_type:this.busiType,product_id:this.productId,price:this.basePrice,attr:h&&h.attr||[],mode:(function(){var k=[];(g.indexOf("OtaCoupon")!=-1)&&k.push("ota");(g.indexOf("MfwCoupon")!=-1)&&k.push("mfw");return k})()},$.proxy(function(k){d("OtaCoupon",k.data.ota_coupon&&k.data.ota_coupon.coupon_code||"");d("MfwCoupon",k.data.mfw_coupon&&k.data.mfw_coupon.coupon_code||"")},this))}if(g.indexOf("Honey")!=-1){var c=this.getPromotionResult("Honey");c&&d("Honey",(c.max_honey<=500)?c.max_honey:0)}if(g.indexOf("RedPacket")!=-1){$.get("/promotions/red_packet/auto",{},$.proxy(function(k){d("RedPacket",k.data&&k.data.accountId||"")},this))}if(g.indexOf("Vip")!=-1){var i=this.getPromotionResult("Vip");i&&d("Vip",i.vip_type?i.vip_type:0)}}});return(function(){var c=new b(),e={},d=["setBusiType","setProductId","setBasePrice","setPromotionParam","getPromotionParam","getPromotionResult","setPromotionCallback","autoSelect"];$.each(d,function(f,g){e[g]=$.proxy(c[g],c)});return e})()});M.closure(function(c){var a=c("/js/module/app/Page"),b=c("dialog/confirm"),f=c("dialog/BindMobileAlert"),g=c("/promotion/js/v2/japp/PromotionModel"),d=c("dialog/alert");var e=new a({events:{"click,._j_confirm":"confirmBoking","click,._j_bargain_close":"jumpOrderCenter","click,._j_yellowtip_close":"hideTips","click,._j_show_risk_warning":"showRiskWarning","click,._j_risk_warning_close":"hideRiskWarning","click,._j_ic_cancel":"hideInternational","click,._j_ic_agree":"agreeInternational","click,._j_ic_check":"checkInternational"},init:function(){if(!window.Env.MOBILE_BINDED){f.pop({title:"应《网络安全法》要求，您需要绑定手机号。",assureWords:"去绑定",hideCloser:true},function(){location.href=window.Env.P_HTTP+"/setting/security/mobile/"})}this.initDom();this.initData();this.initPromotion()},initPagelet:function(){M.Pagelet.wait("_j_pagelet_travel",$.proxy(function(h){this.initStep("travel")},this));M.Pagelet.wait("_j_pagelet_extra_charge",$.proxy(function(h){h.eventInitClick();this.initStep("extra")},this));M.Pagelet.wait("_j_pagelet_tying",$.proxy(function(h){this.initStep("tying");h.onChangePrice()},this));M.Pagelet.wait("_j_pagelet_booked_by",$.proxy(function(h){this.initStep("booked")},this))},bindEvents:function(){M.Event.on("confirm:submit",$.proxy(function(){this.container.find("._j_confirm").trigger("click")},this));M.Event.on("order:price:change",$.proxy(function(i){var j=i.price,h=i.name;this.renderAmountDetail(h,j);this.changePrice(h,j);this.setBookingData(h,i.data)},this));M.Event.on("coupon:center:price:change",$.proxy(function(i){var h="promotion",j=0;$.each(i.list,$.proxy(function(k,l){j+=-l.discount_fee||0;this.renderAmountDetail("promotion_"+l.discount_type,-l.discount_fee||0)},this));this.changePrice(h,j);this.setBookingPromotion(i.list);this.bookingData.verification.reduce_total=-j+(window.Env.reduce_total||0)},this));this.initPagelet()},eventHandlers:{hideTips:function(){$(".yellow-tip").hide()},jumpOrderCenter:function(){window.location.href="/order_center/"},hideInternational:function(h){this.popInternational.hide()},agreeInternational:function(h){var i=$(h.currentTarget);if(!i.hasClass("_j_ic_forbid")){this.bookingData.is_authorized=1;this.popInternational.hide();M.Event.fire("confirm:submit")}},checkInternational:function(i){var j=$(i.currentTarget),h=this.container.find("._j_ic_agree");if(j.hasClass("check-on")){j.removeClass("check-on");h.css("color","#c1c1c1");h.addClass("_j_ic_forbid")}else{h.css("color","#FF9500");j.addClass("check-on");h.removeClass("_j_ic_forbid")}},confirmBoking:function(l){var j=$(l.currentTarget),i="_j_pagelet_booked_by",o="_j_pagelet_tying",p="_j_pagelet_travel",n="_j_pagelet_extra_charge",k=M.Pagelet.getInstance(i),h=M.Pagelet.getInstance(o),q=M.Pagelet.getInstance(p),m=M.Pagelet.getInstance(n);if(q){if(!q.unityCheckIntegrity()){return false}}if(m){if(m.unityCheckIntegrity()){}else{this.goPageletPosition(m);return false}}if(h){if(h.unityCheckIntegrity()){this.bookingData.tying=h.unityData()}else{this.goPageletPosition(h);return false}}if(k){if(k.unityCheckIntegrity()){this.bookingData.booked=k.unityData()}else{this.goPageletPosition(k);return false}}if(!this.unityCheckIntegrityInternational()){return false}var r=this.converPostDataForNew(this.bookingData);if(window.Env.open_ticket_check){console.log(window.Env.open_ticket_check);this.checkTicket(j,r,$.proxy(function(){this.postOrder(j,r)},this))}else{this.postOrder(j,r)}},showRiskWarning:function(){$("body").css("overflow-y","hidden");var h=$("#_j_risk_warning_container");$("body").append(h.tmpl())},hideRiskWarning:function(){$("body").css("overflow-y","auto");$("._j_risk_warning_container_main").remove()}},checkTicket:function(i,h,j){if(i.data("lock")){return}i.data("lock",1);this.showConfirmLoading();$.post("/sales/order/open/ticketCheck",h,$.proxy(function(k){i.data("lock",0);this.hideConfirmLoading();if(k&&k.errno==0){j&&j()}else{if(k&&k.error){d.warning(k.error);this.staConfirmError(k.error)}else{d.warning("生成订单异常，返回重试")}}},this))},postOrder:function(i,h){if(!i.data("lock")){i.data("lock",1);this.showConfirmLoading();this.staConfirm();$.post("/sales/order/rest/create/",h,$.proxy(function(k){if(k&&k.errno==0){if(k&&k.data&&k.data.after&&k.data.after.m_url){if(k.data.after.bargain){var j=k.data.after.bargain;this.showBargain(j.bargain_price,j.bargain_share_num,j.qr_code_url)}else{window.location.href=k.data.after.m_url}}else{d.warning("创建订单异常，返回重试")}}else{if(k&&k.errno==10036){b.pop("页面过期，请刷新页面重试",$.proxy(function(){window.location.reload()},this))}else{if(k&&k.errno==10043){b.pop({title:"交易风险提示",content:k.error},$.proxy(function(){this.bookingData.verification.force_promotion_diff=1;this.container.find("._j_confirm").trigger("click")},this))}else{if(k&&k.error){d.warning(k.error);this.staConfirmError(k.error)}else{d.warning("创建订单异常，返回重试")}}}}this.hideConfirmLoading();i.data("lock",0)},this),"json")}},showBargain:function(j,i,k){var h=$("#_j_bargain_container");$("body").append(h.tmpl({price:j,num:i,src:k}))},showConfirmLoading:function(){this.confirmBtn.hide();this.confirmLoadingBtn.show()},hideConfirmLoading:function(){this.confirmBtn.show();this.confirmLoadingBtn.hide()},setBookingPromotion:function(i){var h={};if(i){$.each(i,function(j,k){if(k.discount_type==="MfwCoupon"){if(+k.discount_fee>0&&k.code){h.coupon=k.code}else{delete h.coupon}}else{if(k.discount_type==="OtaCoupon"){if(+k.discount_fee>0&&k.code){h.coupon_ota=k.code}else{delete h.coupon_ota}}else{if(k.discount_type==="Honey"){if(+k.discount_fee>0&&k.code){h.honey=k.code}else{delete h.honey}}else{if(k.discount_type==="RedPacket"){if(+k.discount_fee>0&&k.code){h.red_packet=k.code;h.reduce_red_packet=k.discount_fee}else{delete h.red_packet;delete h.reduce_red_packet}}else{if(k.discount_type==="MCode"){if(+k.discount_fee>0&&k.code){h.mcode=k.code}else{delete h.mcode}}}}}}})}this.setBookingData("promotion",h)},unityCheckIntegrityInternational:function(){if(window.Env.show_authorized&&!this.bookingData.is_authorized){this.popInternational.show();return false}return true},initData:function(){this.priceStruct={base:window.Env.payment_fee,tying:0,additional:0,promotion:0};this.bookingData=window.Env.booking},initDom:function(){this.paymentFeeDom=this.container.find("._j_amount_payment_fee");this.confirmBtn=$("._j_confirm");this.confirmLoadingBtn=$("._j_confirm_loading");this.popInternational=this.container.find("._j_international_container")},initPromotion:function(){this.bookingData.verification.reduce_total=window.Env.reduce_total||0;g.setBusiType("sales");g.setProductId(window.Env.params.sales_id);g.setBasePrice(window.Env.payment_fee);g.autoSelect([$('[data-japp="order_coupon_pc_v2"][data-model="ota"]').length?"OtaCoupon":null,$('[data-japp="order_coupon_pc_v2"][data-model="mfw"]').length?"MfwCoupon":null,$('[data-japp="order_red_packet_pc"]').length?"RedPacket":null])},allowAmountDetail:function(h){if(typeof this.priceStruct[h]!=="undefined"){return true}return false},renderAmountDetail:function(i,j){var h=this.container.find("._j_amount_"+i);if(h.length){if(j!==0){h.find("em").text((Number(j)||0).toFixed(2)+"元");h.show()}else{h.hide()}}},changePrice:function(i,k){if(this.allowAmountDetail(i)){this.priceStruct[i]=Number(k);var j=0;for(var h in this.priceStruct){j+=Number(this.priceStruct[h])||0}j=j.toFixed(2);this.paymentFeeDom.text(j)}},setBookingData:function(h,i){if(this.bookingData.hasOwnProperty(h)){this.bookingData[h]=i}},converPostDataForNew:function(l){var i={is_new:1},m=["id","stock_id","num","room_num","begin_date","end_date"];m.forEach($.proxy(function(o){if(l.hasOwnProperty(o)){this.setResultData(i,l[o],o,"","")}},this));if(l.booked){for(var j in l.booked){this.setResultData(i,l.booked[j],j,"","")}}if(l&&l.additional&&l.additional.length){l.additional.forEach($.proxy(function(o){if(o.key&&o.key.length&&o.sub_key&&o.sub_key.length){this.setResultData(i,o.data,"section",o.key,o.sub_key)}},this))}if(l.tying&&l.tying.length){var h={name:i.name,phone:i.phone,email:i.email,wechat:i.wechat,section:{insurance:{}}},n=l.tying[0],k=[];if(l.tying&&l.tying.length){l.tying.forEach(function(o){if(o.peoples&&o.peoples.length){o.peoples.forEach(function(p){k.push({name:p.name,identity_id:p.identity_id,stock_id:p.sku_id,begin_date:p.begin_date,end_date:p.end_date})})}})}n.peoples=k;h.section.insurance=n;this.setResultData(i,h,"tiedin","","")}if(l.promotion.coupon&&(l.promotion.coupon+"").length){this.setResultData(i,l.promotion.coupon,"promotion","coupon","")}if(l.promotion.coupon_ota&&(l.promotion.coupon_ota+"").length){this.setResultData(i,l.promotion.coupon_ota,"promotion","coupon_ota","")}if(l.promotion.mcode&&l.promotion.mcode.length){this.setResultData(i,l.promotion.mcode,"promotion","mcode","")}if(l.promotion.honey){this.setResultData(i,l.promotion.honey,"promotion","honey","")}if(l.promotion.red_packet){this.setResultData(i,l.promotion.red_packet,"promotion","red_packet","");this.setResultData(i,l.promotion.reduce_red_packet,"promotion","reduce_red_packet","")}this.setResultData(i,window.Env.params.bargain,"promotion","bargain","");this.setResultData(i,l.verification.force_promotion_diff,"verification","force_promotion_diff","");this.setResultData(i,l.verification.allow_promotion,"verification","allow_promotion","");this.setResultData(i,l.verification.reduce_total,"verification","reduce_total","");return{update:i,after_style:"add_order",post_style:window.Env.version}},setResultData:function(i,k,l,j,h){if(l.length>0){if(typeof i[l]==="undefined"){i[l]={}}}if(j.length>0){if(typeof i[l][j]==="undefined"){i[l][j]={}}}if(h.length>0){if(typeof i[l][j][h]==="undefined"){i[l][j][h]={}}}if(h.length>0){i[l][j][h]=k}else{if(j.length>0){i[l][j]=k}else{if(l.length>0){i[l]=k}}}},goPageletPosition:function(h){if(h&&h.container&&h.container.length){var i=h.container.offset().top;$("html,body").animate({scrollTop:(i-20)+"px"},{duration:300,easing:"swing"})}},initStep:function(h){if(!this.stepPagelet){this.stepPagelet={travel:true,extra:true,tying:true,booked:true}}if(this.stepPagelet[h]){delete this.stepPagelet[h]}if(this.isEmptyObj(this.stepPagelet)){$("._j_step_num").each(function(k,j){var l=$(j);l.text(k+1)})}},isEmptyObj:function(j){var h=0;if(j&&typeof j==="object"){for(var i in j){h++}}if(h){return false}return true},staConfirm:function(){try{mfwPageEvent("sales","order_booking_confirm",({sales_id:window.Env.params.sales_id}))}catch(h){}},staConfirmError:function(i){try{mfwPageEvent("sales","order_booking_confirm_error",({uid:window.Env.params.uid,url:window.location.href,msg:i,}))}catch(h){}}})});M.define("PageAdmin",function(b){var e={},c=d();e.uuid=window.Env&&window.Env.uPageId||a();function a(){var f=c();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(h){var g=(f+Math.random()*16)%16|0;f=Math.floor(f/16);return(h==="x"?g:(g&3|8)).toString(16)})}function d(){var f=window.performance||{},g=f.now||f.mozNow||f.msNow||f.oNow||f.webkitNow||Date.now||function(){return new Date().getTime()};return g}return e});M.define("Storage",function(e,g,b){var n=document;var d=c();var f={_element:null,_expires:null,_file:document.location.hostname,init:function(){if(!this._element){try{this._element=n.createElement("input");this._element.type="hidden";this._element.addBehavior("#default#userData");n.body.appendChild(this._element);this.setItem("__detectUserDataStorage",1);this.removeItem("__detectUserDataStorage");return{setItem:this.setItem,getItem:this.getItem,removeItem:this.removeItem}}catch(p){M.error(p)}}return true},setItem:function(s,t,q){var p=j(q);this._element.expires=p.toUTCString();this._element.load(this._file);var r=a(this._element.getAttribute(s)),u=i(t,+p);this._element.setAttribute(s,u);this._element.save(this._file);k({key:s,newValue:u,oldValue:r,url:window.location.href})},getItem:function(p){this._element.load(this._file);var q=a(this._element.getAttribute(p));return q&&q.value},removeItem:function(p){this._element.load(this._file);this._element.removeAttribute(p);this._element.save(this._file)}};var l={setItem:function(r,s,q){if(!d){return}var p=j(q);localStorage.setItem(r,i(s,+p))},getItem:function(p){if(!d){return}var r=+new Date(),q=a(localStorage.getItem(p));if(q){if(r>q.timestamp){localStorage.removeItem(p);q=null}else{q=q.value}}return q},removeItem:function(p){if(!d){return}localStorage.removeItem(p)}};var h={},m={on:function(q,r){var p=h[q]||(h[q]=[]);p.push(r)},off:function(q,r){var p=h[q];if(!!p){if(!!r){M.forEach(p,function(t,s){if(t==r){p.splice(s,1)}})}else{p=[]}}return this}};M.mix(f,m);M.mix(l,m);if(window.addEventListener){window.addEventListener("storage",k,false)}else{if(window.attachEvent){window.attachEvent("onstorage",k)}}function k(u){if(!u){u=window.event}var p=M.mix({},u),w=u.newValue&&a(u.newValue),q=u.oldValue&&a(u.oldValue),v=+new Date();p.newValue=w&&w.value;if(!!q&&v<q.timestamp){p.oldValue=q.value}else{p.oldValue=null}var t=u.key,s=h[t],r=0;if(!t||!s||0===s.length){return}while(r<s.length){s[r++].call(window,p)}}function j(p){if(Object.prototype.toString.call(p)!="[object Date]"){var q=typeof p==="number"&&p>0?p:86400;p=new Date();p.setTime(+p+q*1000)}return p}function i(q,p){var r={value:q,timestamp:p};return JSON.stringify(r)}function a(p){if(p){try{p=JSON.parse(p);if(!("value" in p)||!("timestamp" in p)){p={value:p,timestamp:+j()}}}catch(q){p={value:p,timestamp:+j()}}}return p}function c(){if(window.localStorage){try{localStorage.setItem("__detectLocalStorage",1);localStorage.removeItem("__detectLocalStorage");return true}catch(p){return false}}return false}var o=window.localStorage?l:f.init();b.exports=M.mix(o,{isAvailable:c,isSupport:window.localStorage?d:("setItem" in o)})});M.define("Cookie",function(f,h,e){var g=/\+/g;var i=navigator.cookieEnabled;if(!i){document.cookie="__detectCookieEnabled=1;";i=document.cookie.indexOf("__detectCookieEnabled")!=-1?true:false;if(i){document.cookie="__detectCookieEnabled=; expires=Thu, 01 Jan 1970 00:00:01 GMT;"}}if(!i){return{isSupport:false}}var d={isSupport:true,set:function(m,n,k){k=(typeof k=="object"&&k!==null)?k:{};if(typeof k.expires==="number"){var o=k.expires,l=k.expires=new Date();l.setTime(+l+o*1000)}return(document.cookie=[j(m),"=",j(String(n)),k.expires?"; expires="+k.expires.toUTCString():"",k.path?"; path="+k.path:"",k.domain?"; domain="+k.domain:"",k.secure?"; secure":""].join(""))},get:function(q){var k=q?undefined:{};var r=document.cookie?document.cookie.split("; "):[];for(var p=0,m=r.length;p<m;p++){var s=r[p].split("=");var n=a(s.shift());var o=s.join("=");if(q&&q===n){k=b(o);break}if(!q&&(o=b(o))!==undefined){k[n]=o}}return k},remove:function(l,k){if(this.get(l)===undefined){return false}k=(typeof k=="object"&&k!==null)?k:{};k.expires=-1;this.set(l,"",k)}};function j(k){return encodeURIComponent(k)}function a(k){return decodeURIComponent(k)}function c(k){if(k.indexOf('"')===0){k=k.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,"\\")}try{k=decodeURIComponent(k.replace(g," "));return k}catch(l){}}function b(k){var l=c(k);return l}e.exports=d});M.define("ResourceKeeper",function(d){var m=b();if(!m){return{isSupport:false}}var c=[];if(window.addEventListener){window.addEventListener("onbeforeunload",l,false)}else{if(window.attachEvent){window.attachEvent("onbeforeunload",l)}}function l(){M.forEach(c,function(n){n.release()})}var e=d("PageAdmin").uuid,j="default_resource",h="__resource_keeper",f=1000,k=2000;function a(n){n=""+n;n=n||j;this.keeping=false;this.resourceKeeperStorageKey=h+"_"+n;this.keepingRefreshInterval=0;this._initStorageListener();c.push(this)}M.mix(a.prototype,{keep:function(){this._requestKeep();return this.keeping},forceKeep:function(n){this._startKeep(n)},release:function(){if(this.keeping){var n=+new Date(),o=g(this.resourceKeeperStorageKey);if(o.currentKeeperPageUUID==e&&o.expire>n){m.remove(this.resourceKeeperStorageKey);this._setKeeping(false)}}},_initStorageListener:function(){M.Event(m).on("resource_keeper_change",M.bind(function(n){if(this.keeping&&n.key==this.resourceKeeperStorageKey&&n.pageUUID&&n.pageUUID!=e){this._setKeeping(false)}},this))},_requestKeep:function(){var n=+new Date(),o=g(this.resourceKeeperStorageKey);if(!o.currentKeeperPageUUID||o.currentKeeperPageUUID==e||o.expire<=n){this._startKeep(n)}else{this._setKeeping(false)}},_startKeep:function(n){n=n||+new Date();var o=n+k;m.set(this.resourceKeeperStorageKey,e+":"+o);this._setKeeping(true)},_setKeeping:function(n){this.keeping=n;if(this.keeping){this._startKeepingRefreshRequest()}else{this._stopKeepingRefreshRequest()}},_startKeepingRefreshRequest:function(){clearInterval(this.keepingRefreshInterval);this.keepingRefreshInterval=setInterval(M.bind(this._requestKeep,this),f)},_stopKeepingRefreshRequest:function(){clearInterval(this.keepingRefreshInterval)}});function b(){var o=null,p=d("Storage");if(p&&p.isSupport){o={set:M.bind(p.setItem,p),get:M.bind(p.getItem,p),remove:M.bind(p.removeItem,p)};if(window.addEventListener){window.addEventListener("storage",function(r){var q=r.key;if(q.indexOf(h)===0){var t="";if(r.newValue){var s=r.newValue.split(":");if(s.length==2){t=s[0]}}M.Event(o).fire("resource_keeper_change",{key:q,pageUUID:t})}},false)}}else{var n=d("Cookie");if(n&&n.isSupport){o={set:function(q,r){return n.set(q,r,k)},get:M.bind(n.get,n),remove:M.bind(n.remove,n)}}}return o}function g(p){var o={currentKeeperPageUUID:"",expire:0},n=m.get(p);if(n){n=n.split(":");o.currentKeeperPageUUID=n[0];o.expire=+n[1]}return o}function i(o){var n=new a(o);return{keep:M.bind(n.keep,n),forceKeep:M.bind(n.forceKeep,n),release:M.bind(n.release,n)}}i.isSupport=true;return i});(function(a){a.jGrowl=function(b,c){if(a("#jGrowl").size()==0){a('<div id="jGrowl"></div>').addClass((c&&c.position)?c.position:a.jGrowl.defaults.position).appendTo("body")}a("#jGrowl").jGrowl(b,c)};a.fn.jGrowl=function(b,d){if(a.isFunction(this.each)){var c=arguments;return this.each(function(){var e=this;if(a(this).data("jGrowl.instance")==undefined){a(this).data("jGrowl.instance",a.extend(new a.fn.jGrowl(),{notifications:[],element:null,interval:null}));a(this).data("jGrowl.instance").startup(this)}if(a.isFunction(a(this).data("jGrowl.instance")[b])){a(this).data("jGrowl.instance")[b].apply(a(this).data("jGrowl.instance"),a.makeArray(c).slice(1))}else{a(this).data("jGrowl.instance").create(b,d)}})}};a.extend(a.fn.jGrowl.prototype,{defaults:{pool:0,header:"",group:"",sticky:false,position:"top-right",glue:"after",theme:"default",themeState:"highlight",corners:"10px",check:250,life:3000,closeDuration:"normal",openDuration:"normal",easing:"swing",closer:true,closeTemplate:"&times;",closerTemplate:"<div>[ 关闭 ]</div>",log:function(c,b,d){},beforeOpen:function(c,b,d){},afterOpen:function(c,b,d){},open:function(c,b,d){},beforeClose:function(c,b,d){},close:function(c,b,d){},animateOpen:{opacity:"show"},animateClose:{opacity:"hide"}},notifications:[],element:null,interval:null,create:function(b,c){var c=a.extend({},this.defaults,c);if(typeof c.speed!=="undefined"){c.openDuration=c.speed;c.closeDuration=c.speed}this.notifications.push({message:b,options:c});c.log.apply(this.element,[this.element,b,c])},render:function(d){var b=this;var c=d.message;var e=d.options;var d=a('<div class="jGrowl-notification '+e.themeState+" ui-corner-all"+((e.group!=undefined&&e.group!="")?" "+e.group:"")+'"><div class="jGrowl-close">'+e.closeTemplate+'</div><div class="jGrowl-header">'+e.header+'</div><div class="jGrowl-message">'+c+"</div></div>").data("jGrowl",e).addClass(e.theme).children("div.jGrowl-close").bind("click.jGrowl",function(){a(this).parent().trigger("jGrowl.close")}).parent();a(d).bind("mouseover.jGrowl",function(){a("div.jGrowl-notification",b.element).data("jGrowl.pause",true)}).bind("mouseout.jGrowl",function(){a("div.jGrowl-notification",b.element).data("jGrowl.pause",false)}).bind("jGrowl.beforeOpen",function(){if(e.beforeOpen.apply(d,[d,c,e,b.element])!=false){a(this).trigger("jGrowl.open")}}).bind("jGrowl.open",function(){if(e.open.apply(d,[d,c,e,b.element])!=false){if(e.glue=="after"){a("div.jGrowl-notification:last",b.element).after(d)}else{a("div.jGrowl-notification:first",b.element).before(d)}a(this).animate(e.animateOpen,e.openDuration,e.easing,function(){if(a.browser.msie&&(parseInt(a(this).css("opacity"),10)===1||parseInt(a(this).css("opacity"),10)===0)){this.style.removeAttribute("filter")}a(this).data("jGrowl").created=new Date();a(this).trigger("jGrowl.afterOpen")})}}).bind("jGrowl.afterOpen",function(){e.afterOpen.apply(d,[d,c,e,b.element])}).bind("jGrowl.beforeClose",function(){if(e.beforeClose.apply(d,[d,c,e,b.element])!=false){a(this).trigger("jGrowl.close")}}).bind("jGrowl.close",function(){a(this).data("jGrowl.pause",true);a(this).animate(e.animateClose,e.closeDuration,e.easing,function(){a(this).remove();var f=e.close.apply(d,[d,c,e,b.element]);if(a.isFunction(f)){f.apply(d,[d,c,e,b.element])}})}).trigger("jGrowl.beforeOpen");if(e.corners!=""&&a.fn.corner!=undefined){a(d).corner(e.corners)}if(a("div.jGrowl-notification:parent",b.element).size()>1&&a("div.jGrowl-closer",b.element).size()==0&&this.defaults.closer!=false){a(this.defaults.closerTemplate).addClass("jGrowl-closer ui-state-highlight ui-corner-all").addClass(this.defaults.theme).appendTo(b.element).animate(this.defaults.animateOpen,this.defaults.speed,this.defaults.easing).bind("click.jGrowl",function(){a(this).siblings().trigger("jGrowl.beforeClose");if(a.isFunction(b.defaults.closer)){b.defaults.closer.apply(a(this).parent()[0],[a(this).parent()[0]])}})}},update:function(){a(this.element).find("div.jGrowl-notification:parent").each(function(){if(a(this).data("jGrowl")!=undefined&&a(this).data("jGrowl").created!=undefined&&(a(this).data("jGrowl").created.getTime()+parseInt(a(this).data("jGrowl").life))<(new Date()).getTime()&&a(this).data("jGrowl").sticky!=true&&(a(this).data("jGrowl.pause")==undefined||a(this).data("jGrowl.pause")!=true)){a(this).trigger("jGrowl.beforeClose")}});if(this.notifications.length>0&&(this.defaults.pool==0||a(this.element).find("div.jGrowl-notification:parent").size()<this.defaults.pool)){this.render(this.notifications.shift())}if(a(this.element).find("div.jGrowl-notification:parent").size()<2){a(this.element).find("div.jGrowl-closer").animate(this.defaults.animateClose,this.defaults.speed,this.defaults.easing,function(){a(this).remove()})}},startup:function(b){this.element=a(b).addClass("jGrowl").append('<div class="jGrowl-notification"></div>');this.interval=setInterval(function(){a(b).data("jGrowl.instance").update()},parseInt(this.defaults.check));if(a.browser.msie&&parseInt(a.browser.version)<7&&!window.XMLHttpRequest){a(this.element).addClass("ie6")}},shutdown:function(){a(this.element).removeClass("jGrowl").find("div.jGrowl-notification").remove();clearInterval(this.interval)},close:function(){a(this.element).find("div.jGrowl-notification").each(function(){a(this).trigger("jGrowl.beforeClose")})}});a.jGrowl.defaults=a.fn.jGrowl.prototype.defaults})(jQuery);if(window.M&&typeof window.M.define=="function"){window.M.define("jq-jgrowl",function(){return jQuery})}M.closure(function(e){var j=e("ResourceKeeper"),t=j.isSupport?new j("new_msg_loop"):null,s=e("Storage"),b=1000,r=10000,u=40000,d=120000;var v=(function(){if(j.isSupport){return $.proxy(t.keep,t)}else{return function(){return M.windowFocused}}}());var k=function(){if(j.isSupport){t.forceKeep()}};if("addEventListener" in window){window.addEventListener("focus",k,false)}else{if("attachEvent" in document){document.attachEvent("onfocusin",k)}}$(function(){if(window.Env&&window.Env.UID>0||window.__mfw_uid>0){setTimeout(n,b)}else{setTimeout(l,r)}$("body").delegate(".jGrowl-closer","click",function(x){$.getJSON("/ajax/ajax_msg.php",{a:"closetip"});s.setItem("jgrowl_close_time",+new Date())});M.Event.on("update msg",function(){setTimeout(function(){w();s.setItem("update_msg",+new Date())},1)});s.on("update_msg",function(x){w()});function w(){if(window.Env&&window.Env.UID>0||window.__mfw_uid>0){p("msgdisplay")}else{p("nologinfeed")}}});function n(){setInterval(function(){v()&&p("msgdisplay")},u)}function l(){var x,w=1;v()&&p("nologinfeed");x=setInterval(function(){v()&&p("nologinfeed");w++;if(w==3){clearInterval(x)}},d)}function p(w){$.get("/ajax/ajax_msg.php?a="+w,function(x){if(x){o(x)}},"json")}function o(w){g();M.Event.fire("get new msg",w);if(w.msg){m()}if(w.tips&&!i()){a(w)}}e("jq-jgrowl");function a(w){var x=w.tips.split(w.split_char);M.forEach(x,function(z,y){if(z){setTimeout(function(){$.jGrowl(z,{header:"新鲜事：",closer:false,life:20000})},2000*y+10)}})}function i(){var x=s.getItem("jgrowl_close_time"),w=+new Date();if(x&&w-x<24*60*60*1000){return true}return false}var c,f=0,h=1000,q=document.title;function m(){g();c=setInterval(function(){if(v()){f++;document.title=f%2===0?"【　　　】 - "+q:"【新消息】 - "+q}else{document.title=q}},h)}function g(){clearInterval(c);document.title=q}});M.define("FrequencyVerifyControl",function(c,b,d){function a(e){this.container=e.container;this.app=e.app;this.successHandler=$.noop;M.mix(this,e);this.init()}a.prototype={init:function(){this.initData();this.refreshImg();this.verifyCon.delegate("img,._j_change_img","click",$.proxy(function(e){this.refreshImg()},this));this.verifyCon.delegate("._j_fre_confirm","click",$.proxy(function(h){var g=this.verifyText.val();var f=g.length;if(f==0){this.showErro("您还没有输入验证码!");return false}else{if(f!==6){this.showErro("请输入正确的验证码!");return false}}var e=$(h.currentTarget);if(e.hasClass("waiting")){return false}e.addClass("waiting");$.post("/user/captcha/verify",{sCode:g,iApp:this.app},$.proxy(function(i){if(i){if(i.ret===1){this.successHandler(this.target);this.verifyCon.hide();this.hideErro()}else{if(i.ret===0){this.verifyText.val("");this.verifyText.focus();this.refreshImg();this.showErro("输入的验证码不正确!")}else{if(i.ret===-1){this.showErro("错误次数过多，请稍候尝试")}}}}e.removeClass("waiting")},this),"json")},this));this.verifyCon.delegate("._j_fre_text","keyup",$.proxy(function(e){if(e.keyCode==13){this.verifyCon.find("._j_fre_confirm").trigger("click")}},this))},showErro:function(e){this.errorCon.html(e);this.errorCon.show()},hideErro:function(){this.errorCon.hide()},initData:function(){this.verifyCon=this.container;this.verifyPo=this.verifyCon.find(".protectedYZM");this.verifyImg=this.verifyCon.find("img");this.verifyText=this.verifyCon.find("._j_fre_text");this.errorCon=this.verifyPo.find(".n-error")},refreshImg:function(){var e="/user/captcha/code?iApp="+this.app+"&s="+new Date().getTime();this.verifyImg.attr("src",e)}};d.exports=a});M.define("FrequencySystemVerify",function(f,e,g){var b=f("dialog/Dialog"),h=f("dialog/Layer"),d=f("FrequencyVerifyControl");var a='<div class="popYzm" style="z-index:inherit;position: relative;width:350px;height: 250px"><div class="protectedYZM" style="border: none;box-shadow: none;padding:25px 15px;"><p>亲爱的蜂蜂，你操作的速度有点像机器人<br>来证明下自己吧~</p><div class="YZMInput"><input class="_j_fre_text" type="text" placeHolder="验证码"></div><div class="YZMInput"><img src="http://images.mafengwo.net/images/home_new2015/verify.gif" width="150px" height="40px"><label><a href="javascript:void(0);" class="_j_change_img">看不清，换一张</a></label></div><div class="YZMSubmit"><a href="javascript:void(0);" class="_j_fre_confirm" title="确定">确定</a><span class="n-error">错误次数过多，请稍候尝试</span></div></div></div>';function c(i){this.app=i.app;this.init()}c.prototype={init:function(){var i=new b({content:a});if(h.getActive()){i.getLayer().setZIndex(h.getActive().getZIndex()+1)}i.show();var j=i.getPanel().find(".popYzm");new d({container:j,app:this.app,successHandler:$.proxy(function(){M.Event.fire("frequency:system:verify:success");i.close()},this)})}};g.exports=c});M.closure(function(d){var b=d("dialog/Dialog"),f=d("dialog/alert"),c=d("FrequencySystemVerify");window.show_login=a;$.ajaxSetup({dataFilter:function(i,h){try{var k=$.parseJSON(i);if(k&&k.unsafe==1){window.location.href="http://www.mafengwo.cn";return"{}"}if(k&&k.error&&k.error.msg=="login:required"){M.Event.fire("login:required");return"{}"}if(k&&k.error&&k.error.msg=="mobilebind:required"){f.pop({title:"依《网络安全法》要求，你需要在发布内容之前绑定手机号~",assureWords:"去绑定",hideCloser:true},function(m){location.href=window.Env.P_HTTP+"/setting/security/mobile/"});return{}}if(k&&k.resource&&k.resource.onload&&k.resource.onload.length){if(k.resource.onload[0]=='K.fire("login:required");'){M.Event.fire("login:required");return"{}"}}if(k&&k.error){var g=0;var l=0;if(typeof(k.error.errno)!=="undefined"){g=k.error.errno;l=k.error.error}else{if(typeof(k.error.code)!=="undefined"){g=k.error.code;l=k.error.msg}}if(g===10000){M.Event.fire("frequency:verify",l);return"{}"}}}catch(j){}return i},error:function(g){if(g.status==401){if(g.responseJSON&&g.responseJSON.data&&g.responseJSON.data.auth_type=="login"){M.Event.fire("login:required")}}}});var e=null;function a(){if($.browser.msie&&parseInt($.browser.version,10)<9){document.location.href=(window.Env&&window.Env.P_HTTP)||"https://passport.mafengwo.cn";return}if(!e){e=new b({PANEL_CLASS:"login_pop",content:'<iframe frameborder="no" border="0" scrolling="no" width="580" height="292" allowtransparency="true"></iframe>',background:"#aaa",bgOpacity:0.6,reposition:true,impl:"logindialog"})}e.show();if(!e.getPanel().find("iframe").attr("src")){M.Event(e).once("aftershow",function(){var g=window.Env.P_HTTP||"https://passport.mafengwo.cn";e.getPanel().find("iframe").attr("src",g+"/login-popup.html")})}}M.Event.on("login:required",a);M.Event.on("frequency:verify",function(g){new c({app:g})});if(M.Event.isFired("login:required")){a()}});M.define("ScrollObserver",function(e,g,c){var h=0,f={},a=false,b,d=true;g.addObserver=function(k){var j="ScrollObserver_"+h;h++;f[j]=k;d=false;return j};g.removeObserver=function(j){delete f[j];if(M.isEmpty(f)){d=true}};function i(){for(var j in f){if(f.hasOwnProperty(j)){f[j]()}}}$(window).scroll(function(){if(d){return}if(!a){b=setInterval(function(){if(a){a=false;clearTimeout(b);i()}},50)}a=true});return g});M.define("QRCode",function(b,a,c){c.exports={gen:function(e,d){var d={text:e,size:d.size||200,eclevel:d.evlevel||"H",logo:d.logo||"",__stk__:window.Env.CSTK};return"http://"+window.Env.WWW_HOST+"/qrcode.php?"+$.param(d)}}});M.closure(function(b){var l=b("ScrollObserver"),m=b("Storage"),d=window.Env||{},f=$("#_j_mfwtoolbar"),h=f.height(),a=$(window).height(),k=$(document).height(),g=$("#footer"),e=g.outerHeight();$("body").css("position","relative");$(window).resize(function(){a=$(window).height();k=$(document).height()});setInterval(function(){var n=$(document).height();if(n!=k){k=n;$(window).trigger("scroll")}},2000);if(!d.hideToolbar){if(!d.showToolbarDownArrow){f.children(".toolbar-item-down").remove()}else{f.children(".toolbar-item-down").show()}f.show();c();l.addObserver(c);f.on("click","._j_gotop",i);f.on("click","._j_gobottom",j);f.children(".toolbar-item-code").mouseenter(function(){$(this).addClass("hover")});f.children(".toolbar-item-code").mouseleave(function(){$(this).removeClass("hover")})}function c(){var n=$(window).scrollTop();if(n>500){f.children(".toolbar-item-top").show()}else{f.children(".toolbar-item-top").hide()}if(g.length){if(n+a>g.offset().top){f.css({position:"absolute",bottom:e+20})}else{f.css({position:"",bottom:""})}}}function i(){$("html, body").animate({scrollTop:0},500,function(){M.Event.fire("scroll to top")})}function j(){$("html, body").animate({scrollTop:k-a},500,function(){M.Event.fire("scroll to bottom")})}});(function(){var a=document.createElement("script"),b=window.Env&&window.Env.CNZZID||30065558;a.type="text/javascript";a.async=true;a.charset="utf-8";a.src=document.location.protocol+"//w.cnzz.com/c.php?id="+b+"&async=1";var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(a,c)})();M.closure(function(a){M.log("只要你有梦想，就加入我们\n你即将见证互联网最新趋势的快速成长\n马蜂窝的一切资源都会成为你成长路上的最大助力\n你可以和马蜂窝一起书写互联网的风云奇迹\n在这里有一群和你一样，疯狂地热爱互联网和旅行的人们\n马蜂窝能为你实现梦想提供最广阔的平台");M.log("请将简历发送至 %csuperhr@mafengwo.com%c（ 邮件标题请以“_console”结尾）","color:#4ae;","color:inherit;");M.log("职位介绍：http://www.mafengwo.cn/s/hr.html")});M.closure(function(a){$.get("/ajax/ajax_page_onload.php",{href:document.location.href,_t:+new Date()},function(b){if(b.payload&&b.payload.apps){var c=b.payload.apps;if(!M.isEmpty(c)){var d={css_list:c.css||[]};M.loadCssJsListSeq(d,function(){if(c.html){$("body").append(c.html)}if(c.js&&c.js.length){M.loadResource(c.js)}})}}},"json")});